---
title: マルチスレッドアプリのデバッグ
description: Visual Studio の [スレッド] ウィンドウと [デバッグの場所] ツールバーを使用してデバッグする
ms.date: 02/14/2020
ms.topic: conceptual
dev_langs:
- CSharp
- VB
- FSharp
- C++
helpviewer_keywords:
- multithreaded debugging, tutorial
- tutorials, multithreaded debugging
ms.assetid: adfbe002-3d7b-42a9-b42a-5ac0903dfc25
author: mikejo5000
ms.author: mikejo
manager: jillfra
ms.workload:
- multiple
ms.openlocfilehash: eb7b7850d8d7582110152d248683f89981933215
ms.sourcegitcommit: 6ef52c2030b37ea7a64fddb32f050ecfb77dd918
ms.translationtype: MT
ms.contentlocale: ja-JP
ms.lasthandoff: 02/17/2020
ms.locfileid: "77416374"
---
# <a name="walkthrough-debug-a-multithreaded-app-using-the-threads-window-c-visual-basic-c"></a>チュートリアル: [スレッド] ウィンドウ (C#、Visual Basic、 C++) を使用したマルチスレッドアプリのデバッグ

いくつかの Visual Studio ユーザーインターフェイス要素は、マルチスレッドアプリのデバッグに役立ちます。 この記事では、コードエディター ウィンドウ、**デバッグの場所** ツールバー、および **スレッド** ウィンドウのマルチスレッドデバッグ機能について説明します。 マルチスレッドアプリをデバッグするためのその他のツールについては、「[マルチスレッドアプリのデバッグの概要](../debugger/get-started-debugging-multithreaded-apps.md)」を参照してください。

このチュートリアルを完了するには数分しかかかりません。マルチスレッドアプリのデバッグの基本を深めることしています。

## <a name="create-a-multithreaded-app-project"></a>マルチスレッドアプリプロジェクトを作成する

このチュートリアルで使用する次のマルチスレッドアプリプロジェクトを作成します。

1. Visual Studio を起動し、新しいプロジェクトを作成します。

   ::: moniker range=">=vs-2019"

   スタート ウィンドウが開いていない場合は、 **[ファイル]** 、>[スタート ウィンドウ]** の順に選択します。

   スタート ウィンドウで、 **[新しいプロジェクトの作成]** を選択します。

   **[新しいプロジェクトの作成]** ウィンドウで、検索ボックスに「*コンソール*」と入力またはタイプします。 次に、 **C#** **C++** 言語 ボックスの一覧から を選択し、プラットフォーム ボックスの一覧から **Windows** を選択します。 

   言語とプラットフォームのフィルターを適用したら、**コンソールアプリ (.net Core)** を選択するかC++、**コンソールアプリ**テンプレートを選択し、 **[次へ]** を選択します。

   > [!NOTE]
   > 正しいテンプレートが表示されない場合は、 **[ツール]**  >  **[ツールと機能の取得]** に移動して、Visual Studio インストーラーを開きます。 **[.NET デスクトップ開発]** ワークロードまたは **[C++ によるデスクトップ開発]** ワークロードを選択し、 **[変更]** を選択します。

   **[新しいプロジェクトの構成]** ウィンドウで、 **[プロジェクト名]** ボックスに「 *mythread」* と入力するか、「」と入力します。 次に、 **[作成]** を選択します。

   ::: moniker-end
   ::: moniker range="vs-2017"
   上部のメニュー バーで、 **[ファイル]** 、 > [新規作成] **、** [プロジェクト] >  の順に選択します。 **[新しいプロジェクト]** ダイアログボックスの左ペインで、次のように選択します。

   - C#アプリの場合、 **[ビジュアルC# ]** の下で **[Windows デスクトップ]** を選択し、中央のウィンドウで **[コンソールアプリ (.NET Framework)]** を選択します。
   - アプリの場合、 **[ビジュアルC++ ]** で **[windows デスクトップ]** 、、 **[windows コンソールアプリケーション]** の順に選択します。 C++

   **コンソールアプリ (.Net Core)** が表示されない場合、またC++は**コンソールアプリケーション**プロジェクトテンプレートの場合は、 **[ツール]**  >  **[ツールと機能の取得]** に移動し、Visual Studio インストーラーを開きます。 **[.NET デスクトップ開発]** ワークロードまたは **[C++ によるデスクトップ開発]** ワークロードを選択し、 **[変更]** を選択します。

   次に、 *Mythreadの*ような名前を入力し、[ **OK]** をクリックします。

   **[OK]** を選択します。
   ::: moniker-end

   新しいコンソール プロジェクトが表示されます。 プロジェクトが作成されると、ソースファイルが表示されます。 選択した言語に応じて、ソースファイルは*Program.cs、* *mythread*、または module1.vb と呼ばれる場合が*あります。*

1. ソースファイル内のコードを、「 C# [マルチスレッドアプリのデバッグを開始](../debugger/get-started-debugging-multithreaded-apps.md)する」のコードC++例に置き換えます。

1. **[ファイル]**  >  **[すべて保存]** を選択します。

## <a name="start-debugging"></a>デバッグを開始する

1. ソースコード内の次の行を探します。

   ```csharp
   Thread.Sleep(3000);
   Console.WriteLine();
   ```

   ```C++
   Thread::Sleep(3000);
   Console.WriteLine();
   ```

1. `Console.WriteLine();` 行にブレークポイントを設定するには、左側の余白をクリックするか、行を選択して**F9**キーを押します。

   ブレークポイントは、コード行の横の左余白に赤い円として表示されます。

1. **[デバッグ]** を選択して**デバッグを開始**するか、 **F5**キーを押し > ます。

   アプリはデバッグモードで起動し、ブレークポイントで一時停止します。

1. 中断モードで **[スレッド]** ウィンドウを開くには、[**デバッグ** > **Windows** > **スレッド**] を選択します。 を開くには、デバッグセッションを使用しているか、**スレッド**とその他のデバッグウィンドウを表示している必要があります。

## <a name="examine-thread-markers"></a>スレッドマーカーを調べる

1. ソースコードで `Console.WriteLine();` の行を見つけます。

   1. **[スレッド]** ウィンドウを右クリックし、[**ソース**のスレッド![を表示]](../debugger/media/dbg-multithreaded-show-threads.png "ThreadMarker")を選択します。

   ソースコード行の横の余白に、*スレッドマーカー*アイコン![スレッドマーカー](../debugger/media/dbg-thread-marker.png "スレッド マーカー")が表示されるようになりました。 スレッド マーカーは、スレッドが停止している位置を示します。 1つの場所に停止しているスレッドが複数ある場合は、[![複数のスレッド](../debugger/media/dbg-multithreaded-show-threads.png "複数のスレッド")] アイコンが表示されます。

1. スレッド マーカーの上にポインターを置きます。 [DataTip] が表示され、停止しているスレッドの名前とスレッド ID 番号が表示されます。 スレッド名は `<No Name>`可能性があります。

   >[!TIP]
   >名前のないスレッドを識別するために、 **[スレッド]** ウィンドウで名前を変更できます。 スレッドを右クリックし、 **[名前の変更]** をクリックします。

1. ソースコード内のスレッドマーカーを右クリックすると、ショートカットメニューの使用可能なオプションが表示されます。

## <a name="flag-and-unflag-threads"></a>スレッドに対するフラグの設定と設定解除を行う

特に注意する必要があるスレッドを追跡するようにスレッドにフラグを付けることができます。

ソースコードエディターまたは **[スレッド]** ウィンドウからスレッドにフラグを付けることができます。 **[デバッグの場所]** または **[スレッド]** ウィンドウのツールバーから、フラグが設定されたスレッドだけを表示するか、すべてのスレッドを表示するかを選択します。 任意の場所からの選択は、すべての場所に影響します。

### <a name="flag-and-unflag-threads-in-source-code"></a>ソースコード内のスレッドに対してフラグを付けるとフラグを解除する

1. デバッグの **[場所]**  > [ > **ツールバー**の**表示**] を選択して、 **[デバッグの場所]** ツールバーを開きます。 また、ツールバーの領域を右クリックし、 **[デバッグの場所]** をクリックすることもできます。

1. **[デバッグの場所]** ツールバーには、**プロセス**、**スレッド**、および**スタックフレーム**の3つのフィールドがあります。 **スレッド**の一覧をドロップダウンして、スレッドの数を確認します。 **スレッド**一覧では、現在実行中のスレッドは **>** シンボルによってマークされます。

1. [ソースコード] ウィンドウで、[余白] のスレッドマーカーアイコンの上にマウスポインターを移動し、[DataTip] のフラグアイコン (または空のフラグアイコンの1つ) を選択します。 フラグアイコンが赤に変わります。

   また、スレッドマーカーアイコンを右クリックし、 **[フラグ]** をポイントして、ショートカットメニューからフラグを付けるスレッドを選択することもできます。

1. **[デバッグの場所]** ツールバーで、 **[スレッド]** フィールドの右側にある フラグが設定された **[スレッドのみを表示]** アイコンを選択します。 ![](../debugger/media/dbg-threads-show-flagged.png "フラグ付きスレッドの表示") 1つ以上のスレッドにフラグが設定されていない場合、アイコンは淡色表示されます。

   フラグが設定されたスレッドだけが、ツールバーの **[スレッド]** ボックスの一覧に表示されるようになりました。 すべてのスレッドを再度表示するには、[フラグが設定された**スレッドのみを表示**] アイコンをもう一度選択します。

   >[!TIP]
   >一部のスレッドにフラグを設定したら、コードエディターにカーソルを置いて右クリックし、[フラグが設定された**スレッドをカーソルに実行**] を選択します。 すべてのフラグが設定されたスレッドがリーチするコードを選択してください。 フラグが設定された**スレッドをカーソルに対して実行する**と、選択したコード行のスレッドが一時停止します。これにより、[スレッドの凍結と凍結](#bkmk_freeze)によって実行の順序を制御しやすくなります。

1. 現在実行中のスレッドのフラグが設定された状態やフラグが設定されていない状態を切り替えるには、[フラグが設定された**スレッドのみ表示**] ボタンの左側にある [**現在のスレッドのフラグ**設定を切り替える] ツールバーボタンを選択します。 現在のスレッドにフラグを設定すると、フラグが設定されたスレッドのみが表示されている場合に、現在のスレッドを見つけるのに役立ちます

1. スレッドのフラグを解除するには、ソースコード内のスレッドマーカーの上にマウスポインターを移動し、赤いフラグアイコンを選択してクリアするか、スレッドマーカーを右クリックして [**フラグ**解除] を選択します。

### <a name="flag-and-unflag-threads-in-the-threads-window"></a>[スレッド] ウィンドウでスレッドに対するフラグとフラグの解除を行う

**[スレッド]** ウィンドウでは、フラグが設定されたスレッドの横に赤いフラグアイコンが表示されますが、フラグが設定されていないスレッドには、空のアイコンがあります。

![[スレッド] ウィンドウ](../debugger/media/dbg-threads-window.png "[スレッド] ウィンドウ")

現在の状態に応じて、スレッドの状態をフラグ付きまたはフラグなしに変更するには、フラグアイコンを選択します。

また、行を右クリックし、ショートカットメニューの [フラグの解除] または [**すべてのスレッド**の**フラグ** **解除] を**クリックすることもできます。

**[スレッド]** ウィンドウのツールバーには、フラグ **[付きスレッドのみを表示]** ボタンもあります。これは、2つのフラグアイコンの1つである右です。 これは、 **[デバッグの場所]** ツールバーのボタンと同じように動作し、どちらのボタンも両方の場所で表示を制御します。

### <a name="other-threads-window-features"></a>スレッドウィンドウのその他の機能

**[スレッド]** ウィンドウで、任意の列のヘッダーを選択して、その列でスレッドを並べ替えます。 並べ替え順序を逆にするには、もう一度を選択します。 すべてのスレッドが表示されている場合は、フラグアイコン列を選択すると、フラグまたはフラグが設定された状態でスレッドが並べ替えられます。

**[スレッド]** ウィンドウの2番目の列 (ヘッダーがない) は、**現在のスレッド**列です。 この列の黄色の矢印は、現在の実行ポイントを示します。

**場所**列には、ソースコード内の各スレッドが表示される場所が表示されます。 **[場所]** エントリの横にある展開矢印を選択するか、エントリをポイントして、そのスレッドの呼び出し履歴の一部を表示します。

>[!TIP]
>スレッドの呼び出し履歴をグラフィカルに表示するには、[[並列スタック](../debugger/using-the-parallel-stacks-window.md)] ウィンドウを使用します。 ウィンドウを開くには、デバッグ中に [**デバッグ**> **Windows** > **並列スタック**] を選択します。

**スレッド**ウィンドウ項目の右クリックコンテキストメニューには、**すべてのスレッド**にフラグ**を付ける、** フラグを解除する、**フラグ**を解除するだけでなく、次のようなものがあります。

- **[ソース内のスレッドの表示]** ボタン。
- **16 進表示**。 **[スレッド]** ウィンドウの**スレッド ID**を10進数から16進数の形式に変更します。
- [スレッドに切り替え](#switch-to-another-thread)ます。これにより、すぐにそのスレッドに実行が切り替わります。
- [**名前**の変更] を使用すると、スレッド名を変更できます。
- [凍結および凍結](#bkmk_freeze)解除コマンド。

## <a name="bkmk_freeze"></a>スレッド実行の凍結と凍結解除

スレッドの凍結と凍結解除、または中断と再開を行って、スレッドが作業を実行する順序を制御できます。 スレッドを凍結および凍結解除すると、デッドロックや競合状態などの同時実行の問題を解決するのに役立ちます。

> [!TIP]
> 一般的なデバッグシナリオでもある、他のスレッドをフリーズせずに1つのスレッドに従うには、「[マルチスレッドアプリケーションのデバッグの開始](../debugger/get-started-debugging-multithreaded-apps.md#bkmk_follow_a_thread)」を参照してください。

**スレッドを凍結および凍結解除するには**

1. **[スレッド]** ウィンドウで、任意のスレッドを右クリックし、 **[フリーズ]** を選択します。 **[現在のスレッド]** 列の **[一時停止]** アイコンは、スレッドが固定されていることを示します。

1. **[スレッド]** ウィンドウのツールバーで **[列]** を選択し、 **[中断回数]** を選択して **[中断カウント]** 列を表示します。 凍結されたスレッドの中断されたカウントの値は**1**です。

1. 凍結されたスレッドを右クリックし、[**凍結**解除] を選択します。

   **[一時停止]** アイコンは表示されなくなり、 **[中断回数]** の値は**0**に変わります。

## <a name="switch-to-another-thread"></a>別のスレッドに切り替える

別のスレッドに切り替えようとすると、 **[アプリケーションは中断モードになってい**ます] ウィンドウが表示される場合があります。 このウィンドウは、現在のデバッガーが表示できるコードがスレッドにないことを示しています。 たとえば、マネージコードをデバッグするときに、スレッドがネイティブコードであるとします。 このウィンドウには、問題を解決するための提案が用意されています。

**別のスレッドに切り替えるには:**

1. **[スレッド]** ウィンドウで、現在のスレッド ID をメモします。これは、**現在**のスレッド列に黄色の矢印が表示されているスレッドです。 アプリを続行するには、このスレッドに切り替える必要があります。

1. 別のスレッドを右クリックし、コンテキストメニューから **[スレッドに切り替え]** を選択します。

1. **[スレッド]** ウィンドウで、黄色い矢印の位置が変更されていることを確認します。 元の現在のスレッドマーカーは、アウトラインとしても残ります。

   コードソースエディターでスレッドマーカーのツールヒントを確認し、 **[デバッグの場所]** ツールバーの **[スレッド]** ボックスの一覧を確認します。 現在のスレッドも変更されていることを確認します。

1. **[デバッグの場所]** ツールバーで、 **[スレッド]** ボックスの一覧から別のスレッドを選択します。 現在のスレッドは、他の2つの場所でも変更されることに注意してください。

1. ソースコードエディターで、スレッドマーカーを右クリックし、 **[スレッドに切り替え]** をポイントして、一覧から別のスレッドを選択します。 現在のスレッドが3つのすべての場所で変更されていることを確認します。

ソースコードでスレッドマーカーを使用すると、その場所で停止したスレッドにのみ切り替えることができます。 **[スレッド]** ウィンドウと **[デバッグの場所]** ツール バーを使用すると、任意のスレッドに切り替えることができます。

マルチスレッドアプリのデバッグの基本を学習しました。 **[スレッド]** ウィンドウ、 **[デバッグの場所]** ツールバーの**スレッド**の一覧、またはソースコードエディターのスレッドマーカーを使用して、スレッドの監視、フラグの解除、およびスレッドの凍結と凍結解除を行うことができます。

## <a name="see-also"></a>参照
- [マルチスレッド アプリケーションのデバッグ](../debugger/debug-multithreaded-applications-in-visual-studio.md)
- [方法 : デバッグ中に別のスレッドに切り替える](../debugger/how-to-switch-to-another-thread-while-debugging.md)
