---
title: 言語サーバー プロトコルの概要 |マイクロソフトドキュメント
ms.date: 11/14/2017
ms.topic: conceptual
ms.assetid: 6a7d93c2-31ea-4bae-8b29-6988a567ddf2
author: acangialosi
ms.author: anthc
manager: jillfra
ms.workload:
- vssdk
ms.openlocfilehash: c3bd5dce3cfb7022a8abb6397dc87b418144cbe1
ms.sourcegitcommit: 16a4a5da4a4fd795b46a0869ca2152f2d36e6db2
ms.translationtype: MT
ms.contentlocale: ja-JP
ms.lasthandoff: 04/06/2020
ms.locfileid: "80703101"
---
# <a name="language-server-protocol"></a>言語サーバー プロトコル

## <a name="what-is-the-language-server-protocol"></a>言語サーバー プロトコルとは何ですか。

ソース コードのオートコンプリートや、エディタや IDE でプログラミング言語の**定義に移動**などの豊富な編集機能をサポートすることは、従来、非常に困難で時間のかかるものです。 通常は、エディタまたは IDE のプログラミング言語でドメインモデル (スキャナ、パーサー、型チェッカ、ビルダーなど) を記述する必要があります。 例えば、Eclipse IDE で C/C++ をサポートする Eclipse CDT プラグインは、Eclipse IDE 自体が Java で書かれているため、Java で記述されています。 このアプローチに従って、Visual Studio Code の TypeScript で C/C++ ドメイン モデルを実装し、Visual Studio 用 C# で別のドメイン モデルを実装することを意味します。

開発ツールで既存の言語固有のライブラリを再利用できる場合は、言語固有のドメイン モデルを作成する方がはるかに簡単です。 ただし、これらのライブラリは通常、プログラミング言語自体で実装されます (たとえば、優れた C/C++ ドメイン モデルは C/C++ で実装されます)。 C/C++ ライブラリを TypeScript で記述されたエディタに統合することは技術的には可能ですが、実行するのは困難です。

### <a name="language-servers"></a>言語サーバー

もう 1 つの方法は、ライブラリを独自のプロセスで実行し、プロセス間通信を使用してライブラリと対話することです。 やり返しするメッセージはプロトコルを形成します。 言語サーバー プロトコル (LSP) は、開発ツールと言語サーバー プロセスの間で交換されるメッセージを標準化する製品です。 言語サーバーや悪魔を使用することは、新しいアイデアや斬新なアイデアではありません。 VimやEmacsのような編集者は、セマンティックオートコンプリートサポートを提供するためにしばらくの間これを行ってきました。 LSP の目的は、このような統合を簡素化し、言語機能をさまざまなツールに公開するための便利なフレームワークを提供することです。

共通のプロトコルを使用すると、言語のドメイン モデルの既存の実装を再利用することで、プログラミング言語の機能を開発ツールに統合できます。 言語サーバーのバックエンドは PHP、Python、Java で記述でき、LSP はさまざまなツールに簡単に統合できます。 このプロトコルは共通の抽象化レベルで機能するため、基になるドメイン モデルに固有のニュアンスを十分に理解する必要なく、ツールが豊富な言語サービスを提供できます。

## <a name="how-work-on-the-lsp-started"></a>LSP での作業の開始方法

LSP は時間の経過とともに進化し、現在ではバージョン 3.0 です。 これは、C# に豊富な編集機能を提供するために、言語サーバーの概念が OmniSharp によって取り上げられたときに始まりました。 最初に、オムニシャープは JSON ペイロードを持つ HTTP プロトコルを使用し、[Visual Studio Code](https://code.visualstudio.com)を含むいくつかのエディターに統合されています。

同じ頃、マイクロソフトは、Emacs や崇高なテキストなどのエディタで TypeScript をサポートするという考えで、TypeScript 言語サーバーで作業を開始しました。 この実装では、エディターは、TypeScript サーバー プロセスと stdin/stdout を介して通信し、要求と応答に V8 デバッガー プロトコルに触発された JSON ペイロードを使用します。 タイプスクリプトサーバーは、豊富なタイプスクリプト編集のためのタイプスクリプト崇高なプラグインとVSコードに統合されています。

2 つの異なる言語サーバーを統合した後、VS Code チームは、エディターと IDE 用の共通言語サーバー プロトコルを調査するようになりました。 共通のプロトコルを使用すると、言語プロバイダーは、異なる IDE で使用できる単一言語サーバーを作成できます。 言語サーバーのコンシューマーは、プロトコルのクライアント側を 1 回実装するだけで済みます。 これにより、言語プロバイダーと言語コンシューマーの両方に win-win の状況が発生します。

言語サーバープロトコルは TypeScript サーバーで使用されるプロトコルで開始され、VS コード言語 API に触発された言語機能を追加して拡張しました。 プロトコルは、そのシンプルさと既存のライブラリのため、リモート呼び出しのためにJSON-RPCでサポートされています。

VS Code チームは、ファイルを lint (スキャン) する要求に応答し、検出された警告とエラーのセットを返すいくつかのリンター言語サーバーを実装して、プロトコルをプロトタイプにしました。 目的は、ユーザーがドキュメント内で編集する際にファイルを lint することであったため、エディター セッション中に多くのリント要求が発生します。 ユーザー編集ごとに新しい linting プロセスを開始する必要がないように、サーバーを稼働状態に保つことが理にかなっています。 VS コードの ESLint および TSLint 拡張機能を含む、いくつかのリンター サーバーが実装されました。 これら 2 つのリンター サーバーは、どちらも TypeScript/JavaScript で実装され、Node.js で実行されます。 プロトコルのクライアントとサーバーの部分を実装するライブラリを共有します。

## <a name="how-the-lsp-works"></a>LSP の動作

言語サーバーは独自のプロセスで実行され、Visual Studio や VS Code などのツールは、JSON-RPC を介して言語プロトコルを使用してサーバーと通信します。 専用プロセスで動作する言語サーバーのもう 1 つの利点は、単一のプロセス モデルに関連するパフォーマンスの問題が回避されるということです。 クライアントとサーバーの両方が Node.js に書き込まれている場合、実際のトランスポート チャネルは、stdio、ソケット、名前付きパイプ、またはノード ipc のいずれかになります。

ルーチン編集セッション中にツールと言語サーバーが通信する方法の例を次に示します。

![lsp フロー図](media/lsp-flow-diagram.png)

* **ツールでファイル (ドキュメントと呼ばれます) を開く**場合 : このツールは、ドキュメントが開いていることを言語サーバーに通知します (「textDocument/didOpen」)。 これからは、ドキュメントの内容に関する真実は、もはやファイルシステム上ではなく、ツールによってメモリに保持されます。

* **ユーザーが編集を行う**: ツールはドキュメントの変更 ('textDocument/didChange') をサーバーに通知し、プログラムのセマンティック情報は言語サーバーによって更新されます。 この場合、言語サーバーはこの情報を分析し、検出されたエラーと警告 ('textDocument/publishDiagnostics') をツールに通知します。

* **ユーザーがエディタのシンボルで「定義に移動」を実行**する: ツールは、(1) ドキュメント URI と (2) 定義への移動要求が開始されたテキスト位置の 2 つのパラメーターを持つ 「textDocument/definition」要求をサーバーに送信します。 サーバーは、ドキュメント URI と、ドキュメント内のシンボルの定義の位置を返します。

* **ユーザーはドキュメント (ファイル) を閉じる**: 'textDocument/didClose' 通知がツールから送信され、ドキュメントがメモリになくなったこと、および現在の内容がファイル システム上で最新であることを言語サーバーに通知します。

この例は、"定義に移動する" 「すべての参照を検索する」などのエディター機能のレベルで、プロトコルが言語サーバーと通信する方法を示しています。 プロトコルで使用されるデータ型は、現在開いているテキストドキュメントやカーソルの位置のようなエディタまたはIDEの「データ型」です。 データ型は、通常、抽象構文ツリーとコンパイラ シンボル (解決された型、名前空間など) を提供するプログラミング言語ドメイン モデルのレベルではありません。これにより、プロトコルが大幅に簡素化されます。

次に、「textDocument/定義」要求について詳しく説明します。 以下は、クライアント ツールと C++ ドキュメントの "定義に移動" 要求の言語サーバーとの間に送信されるペイロードです。

これは、要求です。

```json
{
    "jsonrpc": "2.0",
    "id" : 1,
    "method": "textDocument/definition",
    "params": {
        "textDocument": {
            "uri": "file:///p%3A/mseng/VSCode/Playgrounds/cpp/use.cpp"
        },
        "position": {
            "line": 3,
            "character": 12
        }
    }
}
```

これは応答です:

```json
{
    "jsonrpc": "2.0",
    "id": "1",
    "result": {
        "uri": "file:///p%3A/mseng/VSCode/Playgrounds/cpp/provide.cpp",
        "range": {
            "start": {
                "line": 0,
                "character": 4
            },
            "end": {
                "line": 0,
                "character": 11
            }
        }
    }
}
```

振り返ってみると、プログラミング言語モデルのレベルではなく、エディタのレベルでデータ型を記述することが、言語サーバープロトコルが成功する理由の1つです。 抽象構文ツリーとコンパイラ シンボルを異なるプログラミング言語間で標準化するのと比較して、テキスト ドキュメント URI またはカーソル位置を標準化する方がはるかに簡単です。

ユーザーが異なる言語で作業している場合、VS Code は通常、プログラミング言語ごとに言語サーバーを起動します。 以下の例は、ユーザーが Java ファイルと SASS ファイルで作業するセッションを示しています。

![ジャワとサス](media/lsp-java-and-sass.png)

### <a name="capabilities"></a>機能

すべての言語サーバーが、プロトコルで定義されたすべての機能をサポートできるわけではありません。 したがって、クライアントとサーバーは、サポートされている機能セットを 「機能」を通じてアナウンスします。 例として、サーバーは 'textDocument/definition' 要求を処理できることをアナウンスしますが、'ワークスペース/シンボル' 要求を処理しない可能性があります。 同様に、クライアントは、ドキュメントが保存される前に「保存しようとしている」通知を提供できることを通知できるため、サーバーはテキスト編集を計算して編集したドキュメントを自動的に書式設定できます。

## <a name="integrating-a-language-server"></a>言語サーバーの統合

言語サーバーを特定のツールに実際に統合することは、言語サーバープロトコルによって定義されず、ツールの実装者に任されます。 一部のツールでは、任意の種類の言語サーバーを起動して会話できる拡張機能を持つことによって、言語サーバーを一般的に統合します。 VS Code などの他の言語サーバーごとにカスタム拡張機能を作成し、拡張機能がカスタム言語機能を提供できるようにします。

言語サーバーとクライアントの実装を簡素化するために、クライアントとサーバーの部分用のライブラリまたは SDK があります。 これらのライブラリは、異なる言語用に提供されています。 たとえば、[言語クライアント npm モジュール](https://www.npmjs.com/package/vscode-languageclient)は、言語サーバーを VS Code 拡張機能に統合しやすくし、Node.js を使用して言語サーバーを記述する別の[言語サーバー npm モジュール](https://www.npmjs.com/package/vscode-languageserver)があります。 これは、現在のサポート ライブラリの[一覧](https://github.com/Microsoft/language-server-protocol/wiki/Protocol-Implementations)です。

## <a name="using-the-language-server-protocol-in-visual-studio"></a>言語サーバー プロトコルの使用

* [言語サーバー プロトコル拡張機能の追加](adding-an-lsp-extension.md)- 言語サーバーを Visual Studio に統合する方法について説明します。
