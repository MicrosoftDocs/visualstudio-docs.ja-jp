---
title: ClickOnce | を使用した COM コンポーネントの配置Microsoft Docs
description: レガシ COM コンポーネントを含む ClickOnce で .NET アプリケーションを配置するために必要な手順について説明します。
ms.custom: SEO-VS-2020
ms.date: 11/04/2016
ms.topic: conceptual
dev_langs:
- VB
- CSharp
- C++
helpviewer_keywords:
- registration-free COM deployment
- ClickOnce deployment, COM components
- COM components, deploying
- deploying applications [ClickOnce], COM components
- components, deploying
ms.assetid: 1a4c7f4c-7a41-45f2-9af4-8b1666469b89
author: mikejo5000
ms.author: mikejo
manager: jillfra
ms.workload:
- multiple
ms.openlocfilehash: 4fc6ef0e4d682f0f712eefc4c139895331c31688
ms.sourcegitcommit: 0893244403aae9187c9375ecf0e5c221c32c225b
ms.translationtype: MT
ms.contentlocale: ja-JP
ms.lasthandoff: 11/09/2020
ms.locfileid: "94382924"
---
# <a name="deploy-com-components-with-clickonce"></a>ClickOnce での COM コンポーネントの配置
従来の COM コンポーネントの展開は、従来は難しい作業でした。 コンポーネントはグローバルに登録されている必要があるため、重複するアプリケーション間で望ましくない副作用が発生する可能性があります。 この状況は、通常、コンポーネントがアプリケーションに完全に分離されているか、side-by-side 互換性があるため、.NET Framework アプリケーションでは問題になりません。 Visual Studio では、Windows XP 以降のオペレーティングシステムに分離された COM コンポーネントを配置できます。

 [!INCLUDE[ndptecclick](../deployment/includes/ndptecclick_md.md)] .NET アプリケーションを配置するための簡単で安全な機構を提供します。 ただし、アプリケーションでレガシ COM コンポーネントを使用する場合は、追加の手順を実行して展開する必要があります。 このトピックでは、分離 COM コンポーネントを配置する方法とネイティブコンポーネントを参照する方法について説明します (たとえば、Visual Basic 6.0 や Visual C++)。

 分離された COM コンポーネントの配置の詳細については、「 [ClickOnce と Registration-Free COM によるアプリのデプロイの簡素化](https://web.archive.org/web/20050326005413/msdn.microsoft.com/msdnmag/issues/05/04/RegFreeCOM/default.aspx)」を参照してください。

## <a name="registration-free-com"></a>登録を必要としない COM
 登録を不要にした COM は、分離された COM コンポーネントを展開およびアクティブ化するための新しいテクノロジです。 これは、通常システムレジストリにインストールされているすべてのコンポーネントのタイプライブラリと登録情報を、アプリケーションと同じフォルダーに格納されたマニフェストと呼ばれる XML ファイルに配置することによって機能します。

 COM コンポーネントを分離するには、開発者のコンピューターに登録する必要がありますが、エンドユーザーのコンピューターに登録する必要はありません。 COM コンポーネントを分離するには、その参照の **分離** プロパティを **True** に設定するだけで済みます。 既定では、このプロパティは **False** に設定されています。これは、登録済みの COM 参照として処理する必要があることを示します。 このプロパティが **True** の場合、ビルド時にこのコンポーネントのマニフェストが生成されます。 また、インストール中に、対応するファイルがアプリケーションフォルダーにコピーされます。

 マニフェストジェネレーターは、分離された COM 参照を検出すると、 `CoClass` コンポーネントのタイプライブラリ内のすべてのエントリを列挙し、各エントリを対応する登録データと照合して、タイプライブラリファイル内のすべての COM クラスのマニフェスト定義を生成します。

## <a name="deploy-registration-free-com-components-using-clickonce"></a>ClickOnce を使用して登録を不要にする COM コンポーネントを配置する
 [!INCLUDE[ndptecclick](../deployment/includes/ndptecclick_md.md)] 配置テクノロジは、分離された COM コンポーネントを配置する場合に適しています。これは、 [!INCLUDE[ndptecclick](../deployment/includes/ndptecclick_md.md)] と登録を必要としない com の両方で、コンポーネントにマニフェストを配置する必要があるためです。

 通常、コンポーネントの作成者はマニフェストを提供する必要があります。 それ以外の場合、Visual Studio は COM コンポーネントに対して自動的にマニフェストを生成することができます。 マニフェスト生成は発行プロセス中に実行されます [!INCLUDE[ndptecclick](../deployment/includes/ndptecclick_md.md)] 。詳細については、「 [ClickOnce アプリケーションの発行](../deployment/publishing-clickonce-applications.md)」を参照してください。 この機能を使用すると、Visual Basic 6.0 など、以前の開発環境で作成したレガシコンポーネントを利用することもできます。

 COM コンポーネントを展開するには、次の2つの方法があり [!INCLUDE[ndptecclick](../deployment/includes/ndptecclick_md.md)] ます。

- ブートストラップを使用して COM コンポーネントを配置します。これは、サポートされているすべてのプラットフォームで動作します。

- ネイティブコンポーネント分離 (登録不要の COM とも呼ばれます) の展開を使用します。 ただし、これは Windows XP 以降のオペレーティングシステムでのみ機能します。

### <a name="example-of-isolating-and-deploying-a-simple-com-component"></a>単純な COM コンポーネントを分離して配置する例
 この例では、登録を必要としない COM コンポーネントの配置を示すために、Visual Basic 6.0 を使用して作成された分離ネイティブ COM コンポーネントを参照する Visual Basic で Windows ベースのアプリケーションを作成し、を使用して展開し [!INCLUDE[ndptecclick](../deployment/includes/ndptecclick_md.md)] ます。

 まず、ネイティブ COM コンポーネントを作成する必要があります。

##### <a name="to-create-a-native-com-component"></a>ネイティブ COM コンポーネントを作成するには

1. Visual Basic 6.0 を使用して、[ **ファイル** ] メニューの [ **新規作成** ]、[ **プロジェクト** ] の順にクリックします。

2. [ **新しいプロジェクト** ] ダイアログボックスで、[ **Visual Basic** ] ノードを選択し、 **ActiveX DLL** プロジェクトを選択します。 **[名前]** ボックスに「 `VB6Hello`」と入力します。

    > [!NOTE]
    > 登録を不要な COM では、ActiveX DLL および ActiveX コントロールプロジェクトの種類のみがサポートされます。ActiveX EXE および ActiveX ドキュメントプロジェクトの種類はサポートされていません。

3. **ソリューションエクスプローラー** で、[ **Class1** ] をダブルクリックして、テキストエディターを開きます。

4. Class1 で、メソッドの生成されたコードの後に次のコードを追加します `New` 。

    ```vb
    Public Sub SayHello()
       MsgBox "Message from the VB6Hello COM component"
    End Sub
    ```

5. コンポーネントをビルドします。 **[ビルド]** メニューの **[ソリューションのビルド]** をクリックします。

> [!NOTE]
> 登録を不要にする COM は、プロジェクトの種類として Dll と COM コントロールのみをサポートします。 登録を必要としない COM では、Exe を使用できません。

 これで、Windows ベースのアプリケーションを作成し、COM コンポーネントへの参照を追加できるようになりました。

##### <a name="to-create-a-windows-based-application-using-a-com-component"></a>COM コンポーネントを使用して Windows ベースのアプリケーションを作成するには

1. Visual Basic を使用して、[ **ファイル** ] メニューの [ **新規作成** ]、[ **プロジェクト** ] の順にクリックします。

2. [ **新しいプロジェクト** ] ダイアログボックスで、[ **Visual Basic** ] ノードを選択し、[ **Windows アプリケーション** ] を選択します。 **[名前]** ボックスに「 `RegFreeComDemo`」と入力します。

3. **ソリューションエクスプローラー** で、[ **すべてのファイルを表示** ] ボタンをクリックして、プロジェクト参照を表示します。

4. [ **参照** ] ノードを右クリックし、コンテキストメニューから [ **参照の追加** ] を選択します。

5. [ **参照の追加** ] ダイアログボックスで、[ **参照** ] タブをクリックし、VB6Hello.dll に移動して、それを選択します。

    参照の一覧に **VB6Hello** 参照が表示されます。

6. [ **ツールボックス** ] をポイントし、 **ボタン** コントロールを選択して、 **Form1** フォームにドラッグします。

7. [ **プロパティ** ] ウィンドウで、ボタンの **Text** プロパティを " **Hello** " に設定します。

8. このボタンをダブルクリックしてハンドラーコードを追加し、コードファイルにコードを追加して、ハンドラーが次のように読み取られるようにします。

   ```vb
   Private Sub Button1_Click(ByVal sender As System.Object, ByVal e As System.EventArgs) Handles Button1.Click
       Dim VbObj As New VB6Hello.Class1
       VbObj.SayHello()
   End Sub
   ```

9. アプリケーションを実行します。 **[デバッグ]** メニューの **[デバッグの開始]** をクリックします。

   次に、コントロールを分離する必要があります。 アプリケーションが使用する各 COM コンポーネントは、プロジェクト内で COM 参照として表現されます。 これらの参照は、[ **ソリューションエクスプローラー** ] ウィンドウの [ **参照** ] ノードの下に表示されます。 (参照を直接追加するには、[ **プロジェクト** ] メニューの [ **参照の追加** ] コマンドを使用するか、または ActiveX コントロールをフォームにドラッグして間接的に追加します)。

   次の手順では、COM コンポーネントを分離し、分離されたコントロールを含む更新されたアプリケーションを発行する方法について説明します。

##### <a name="to-isolate-a-com-component"></a>COM コンポーネントを分離するには

1. **ソリューションエクスプローラー** の [ **参照** ] ノードで、 **VB6Hello** 参照を選択します。

2. [ **プロパティ** ] ウィンドウで、 **分離** されたプロパティの値を **False** から **True** に変更します。

3. **[ビルド]** メニューの **[ソリューションのビルド]** をクリックします。

   ここで、F5 キーを押すと、アプリケーションは正常に動作しますが、現在は登録を必要としない COM の下で実行されています。 これを証明するために、VB6Hello.dll コンポーネントの登録を解除し、Visual Studio IDE の外部で RegFreeComDemo1.exe を実行してみてください。 このとき、ボタンがクリックされても動作します。 アプリケーションマニフェストの名前を一時的に変更すると、再度失敗します。

> [!NOTE]
> COM コンポーネントの登録を一時的に解除することによって、COM コンポーネントが存在しないことをシミュレートできます。 コマンドプロンプトを開き、「」と入力してシステムフォルダーにアクセスし、「」と入力して `cd /d %windir%\system32` コンポーネントの登録を解除し `regsvr32 /u VB6Hello.dll` ます。 「」と入力すると、再度登録でき `regsvr32 VB6Hello.dll` ます。

 最後の手順では、次のようにを使用してアプリケーションを発行し [!INCLUDE[ndptecclick](../deployment/includes/ndptecclick_md.md)] ます。

##### <a name="to-publish-an-application-update-with-an-isolated-com-component"></a>分離 COM コンポーネントを使用してアプリケーションの更新プログラムを発行するには

1. [ **ビルド** ] メニューの [ **RegFreeComDemo の発行** ] をクリックします。

    発行ウィザードが表示されます。

2. 発行ウィザードで、発行されたファイルにアクセスして確認できるローカルコンピューターのディスク上の場所を指定します。

3. **[完了]** をクリックして、アプリケーションを発行します。

   発行されたファイルを調べると、sysmon ファイルが含まれていることに注意してください。 このコントロールは、このアプリケーションに完全に分離されています。つまり、エンドユーザーのコンピューターに別のバージョンのコントロールを使用する別のアプリケーションがある場合、このアプリケーションに干渉することはありません。

## <a name="reference-native-assemblies"></a>参照 (ネイティブアセンブリを)
 Visual Studio では、ネイティブ Visual Basic 6.0 または C++ アセンブリへの参照がサポートされています。このような参照は、ネイティブ参照と呼ばれます。 " **ファイルの種類** " プロパティが " **ネイティブ** " または " **ActiveX** " に設定されていることを確認することで、参照がネイティブかどうかを判断できます。

 ネイティブ参照を追加するには、[ **参照の追加** ] コマンドを使用し、マニフェストを参照します。 コンポーネントによっては、DLL 内にマニフェストが配置されます。 この場合、DLL 自体を選択するだけで、コンポーネントに埋め込みのマニフェストが含まれていることが検出された場合、Visual Studio はそれをネイティブ参照として追加します。 また、参照されているコンポーネントと同じフォルダーにある場合は、Visual Studio によって、マニフェストに一覧表示されている依存ファイルまたはアセンブリも自動的に追加されます。

 COM コントロールの分離を使用すると、まだマニフェストを持っていない COM コンポーネントを簡単に配置できます。 ただし、コンポーネントにマニフェストが指定されている場合は、マニフェストを直接参照できます。 実際には、 **分離** されたプロパティを使用するのではなく、可能な限り、コンポーネントの作成者によって提供されるマニフェストを常に使用する必要があります。

## <a name="limitations-of-registration-free-com-component-deployment"></a>登録を不要にする COM コンポーネントの展開の制限事項
 登録を不要にする COM は、従来のデプロイ手法よりも明確な利点を提供します。 ただし、いくつかの制限事項と注意事項も指摘する必要があります。最大の制限は、Windows XP 以降でのみ機能することです。 登録を必要としない COM の実装では、コアオペレーティングシステムへのコンポーネントの読み込み方法を変更する必要がありました。 残念ながら、登録を必要としない COM の下位レベルのサポートレイヤーはありません。

 すべてのコンポーネントが、登録を不要な COM に適した候補ではありません。 次のいずれかに該当する場合、コンポーネントは適切ではありません。

- コンポーネントはアウトプロセスサーバーです。 EXE サーバーはサポートされていません。Dll のみがサポートされています。

- コンポーネントは、オペレーティングシステムの一部であるか、または XML、Internet Explorer、Microsoft Data Access Components (MDAC) などのシステムコンポーネントです。 コンポーネントの作成者の再配布ポリシーに従う必要があります。ベンダーに確認してください。

- コンポーネントは、Microsoft Office などのアプリケーションの一部です。 たとえば、Microsoft Excel オブジェクトモデルを分離しないようにする必要があります。 これは Office の一部であり、完全な Office 製品がインストールされているコンピューターでのみ使用できます。

- このコンポーネントは、アドインまたはスナップインとして使用することを目的としています。たとえば、Office アドインや、Web ブラウザーでのコントロールです。 通常、このようなコンポーネントには、マニフェスト自体のスコープを超えるホスティング環境で定義されている何らかの登録スキームが必要です。

- コンポーネントは、システムの物理デバイスまたは仮想デバイス (たとえば、印刷スプーラ用のデバイスドライバー) を管理します。

- コンポーネントは、データアクセス再頒布可能パッケージです。 通常、データアプリケーションを実行するには、別のデータアクセス再頒布可能パッケージがインストールされている必要があります。 Microsoft ADO データコントロール、Microsoft OLE DB、または Microsoft Data Access Components (MDAC) などのコンポーネントを分離しないようにしてください。 代わりに、アプリケーションで MDAC または SQL Server Express を使用する場合は、前提条件として設定する必要があります。「 [方法: ClickOnce アプリケーションを使用して必須コンポーネントをインストール](../deployment/how-to-install-prerequisites-with-a-clickonce-application.md)する」を参照してください。

  場合によっては、コンポーネントの開発者が、登録を必要としない COM 用に再設計できる可能性があります。 これが不可能な場合でも、ブートストラップを使用して標準の登録スキームを使用して、それらに依存するアプリケーションをビルドして発行することができます。 詳細については、「 [ブートストラップパッケージの作成](../deployment/creating-bootstrapper-packages.md)」を参照してください。

  COM コンポーネントは、アプリケーションごとに1回のみ分離できます。 たとえば、同じアプリケーションの一部である2つの異なる **クラスライブラリ** プロジェクトから、同じ COM コンポーネントを分離することはできません。 このようにすると、ビルドの警告が表示され、実行時にアプリケーションの読み込みに失敗します。 この問題を回避するために、1つのクラスライブラリに COM コンポーネントをカプセル化することをお勧めします。

  アプリケーションの配置に登録が不要な場合でも、開発者のコンピューターに COM 登録が必要になるシナリオがいくつかあります。 このプロパティを使用するには、 `Isolated` ビルド中にマニフェストを自動生成するために、COM コンポーネントが開発者のコンピューターに登録されている必要があります。 ビルド中に自己登録を呼び出す登録キャプチャ機能はありません。 また、タイプライブラリで明示的に定義されていないクラスは、マニフェストに反映されません。 ネイティブ参照など、既存のマニフェストで COM コンポーネントを使用する場合、開発時にコンポーネントを登録する必要がないことがあります。 ただし、コンポーネントが ActiveX コントロールであり、 **ツールボックス** と Windows フォームデザイナーに追加する場合は、登録が必要です。

## <a name="see-also"></a>関連項目
- [ClickOnce のセキュリティと配置](../deployment/clickonce-security-and-deployment.md)