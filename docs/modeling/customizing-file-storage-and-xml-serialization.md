---
title: ファイル格納処理および XML シリアル化処理のカスタマイズ
description: Visual Studio でドメイン固有言語 (DSL) のインスタンス、つまりモデルを保存するときに作成または更新される XML ファイルについて説明します。
ms.custom: SEO-VS-2020
ms.date: 11/04/2016
ms.topic: how-to
f1_keywords:
- vs.dsltools.dsldesigner.xmlbehavior
helpviewer_keywords:
- Domain-Specific Language, serialization
author: JoshuaPartlow
ms.author: joshuapa
manager: jmartens
ms.workload:
- multiple
ms.openlocfilehash: 019f77320e9118d5f3d31e647a59c71bb474d204
ms.sourcegitcommit: ae6d47b09a439cd0e13180f5e89510e3e347fd47
ms.translationtype: HT
ms.contentlocale: ja-JP
ms.lasthandoff: 02/08/2021
ms.locfileid: "99935536"
---
# <a name="customize-file-storage-and-xml-serialization"></a>ファイル格納処理および XML シリアル化処理をカスタマイズする

ユーザーが Visual Studio でドメイン固有言語 (DSL) のインスタンス、つまり "*モデル*" を保存すると、XML ファイルが作成または更新されます。 ファイルを再度読み込んで、ストアにモデルを再作成することができます。

DSL エクスプローラーで **[XML シリアル化の動作]** の設定を調整することで、シリアル化スキームをカスタマイズできます。 ドメインクラス、プロパティ、およびリレーションシップのそれぞれについて、 **[XML シリアル化の動作]** の下にノードがあります。 リレーションシップは、ソース クラスの下に配置されます。 シェイプ、コネクタ、および図のクラスに対応するノードもあります。

さらに高度なカスタマイズのためのプログラム コードを記述することもできます。

> [!NOTE]
> 特定の形式でモデルを保存するものの、そのフォームから再度読み込む必要がない場合は、カスタムのシリアル化スキームではなく、テキスト テンプレートを使用してモデルからの出力を生成することを検討します。 詳細については、「[ドメイン固有言語からのコード生成](../modeling/generating-code-from-a-domain-specific-language.md)」を参照してください。

## <a name="model-and-diagram-files"></a>モデルと図のファイル

各モデルは通常、2 つのファイルに保存されます。

- モデル ファイルには、**Model1.mydsl** などの名前が付けられます。 モデル要素、リレーションシップ、およびそれらのプロパティが格納されます。 **.mydsl** などのファイル拡張子は、DSL 定義の **[エディター]** ノードの **FileExtension** プロパティによって決定されます。

- 図のファイルには、**Model1.mydsl.diagram** などの名前が付けられます。 シェイプ、コネクタ、その位置、色、線の太さなど、図の外観に関する詳細が格納されます。 ユーザーが **.diagram** ファイルを削除しても、モデル内の重要な情報は失われません。 図のレイアウトだけが失われます。 モデル ファイルを開くと、既定のシェイプとコネクタのセットが作成されます。

### <a name="to-change-the-file-extension-of-a-dsl"></a>DSL のファイル拡張子を変更するには

1. DSL 定義を開きます。 DSL エクスプローラーで、[エディター] ノードをクリックします。

2. [プロパティ] ウィンドウで、**FileExtension** プロパティを編集します。 ファイル名拡張子の最初の "." は含めないでください。

3. ソリューション エクスプローラーで、**DslPackage\ProjectItemTemplates** 内にある 2 つの項目テンプレート ファイルの名前を変更します。 これらのファイルには、次の形式で名前が付いています。

     `myDsl.diagram`

     `myDsl.myDsl`

## <a name="the-default-serialization-scheme"></a>既定のシリアル化スキーム

このトピックの例を作成するために、次の DSL 定義を使用しました。

![DSL 定義図 &#45; ファミリ ツリー モデル](../modeling/media/familyt_person.png)

この DSL を使用して、画面上に次のような外観のモデルを作成しました。

![ファミリ ツリー ダイアグラム、ツールボックス、およびエクスプローラー](../modeling/media/familyt_instance.png)

このモデルを保存し、XML テキスト エディターで再び開きました。

```xml
<?xml version="1.0" encoding="utf-8"?>
<familyTreeModel xmlns:dm0="http://schemas.microsoft.com/VisualStudio/2008/DslTools/Core" dslVersion="1.0.0.0" Id="f817b728-e920-458e-bb99-98edc469d78f" xmlns="http://schemas.microsoft.com/dsltools/FamilyTree">
  <people>
    <person name="Henry VIII" birthYear="1491" deathYear="1547" age="519">
      <children>
        <personMoniker name="/f817b728-e920-458e-bb99-98edc469d78f/Elizabeth I" />
        <personMoniker name="/f817b728-e920-458e-bb99-98edc469d78f/Mary" />
      </children>
    </person>
    <person name="Elizabeth I" birthYear="1533" deathYear="1603" age="477" />
    <person name="Mary" birthYear="1515" deathYear="1558" age="495" />
  </people>
</familyTreeModel>
```

シリアル化モデルについて、次の点に注意してください。

- 各 XML ノードにはドメイン クラス名と同じ名前が付けられますが、最初の文字は小文字である点が異なります。 たとえば、`familyTreeModel` と`person` です。

- Name や BirthYear などのドメイン プロパティは、XML ノードの属性としてシリアル化されます。 ここでも、プロパティ名の最初の文字が小文字に変換されます。

- 各リレーションシップは、リレーションシップのソース エンド内で入れ子になった XML ノードとしてシリアル化されます。 ノードの名前は、ソース ロール プロパティと同じですが、小文字の先頭文字が使用されます。

     たとえば、DSL 定義では、**People** という名前のロールは **FamilyTree** クラスをソースとしています。  XML では、これは `familyTreeModel` ノード内に入れ子にされた `people` という名前のノードによって表されます。

- 各埋め込みリレーションシップのターゲット エンドは、リレーションシップの下で入れ子になったノードとしてシリアル化されます。 たとえば、`people` ノードに複数の `person` ノードが含まれているとします。

- 各参照リレーションシップのターゲット エンドは、ターゲット要素への参照をエンコードする "*モニカー*" としてシリアル化されます。

     たとえば、`person` ノードの下に `children` リレーションシップが存在する場合があります。 このノードには、次のようなモニカーが含まれています。

    ```xml
    <personMoniker name="/f817b728-e920-458e-bb99-98edc469d78f/Elizabeth I" />
    ```

## <a name="understand-monikers"></a>モニカーについて

モニカーは、モデル ファイルと図ファイルの異なる部分の間の相互参照を表すために使用されます。 また、モデル ファイル内のノードを参照するために `.diagram` ファイルでも使用されます。 モニカーには 2 つの形式があります。

- "*ID モニカー*" では、ターゲット要素の GUID を引用します。 次に例を示します。

    ```xml
    <personShapeMoniker Id="f79734c0-3da1-4d72-9514-848fa9e75157" />
    ```

- "*修飾キー モニカー*" では、モニカー キーと呼ばれる指定されたドメイン プロパティの値によってターゲット要素を識別します。 ターゲット要素のモニカーには、埋め込みリレーションシップのツリーにおける親要素のモニカーがプレフィックスとして付けられます。

     次に、ドメイン クラス Song への埋め込みリレーションシップを持つドメイン クラス Album が存在する DSL からの例を示します。

    ```xml
    <albumMoniker title="/My Favorites/Jazz after Teatime" />
    <songMoniker title="/My Favorites/Jazz after Teatime/Hot tea" />
    ```

     修飾キー モニカーは、 **[XML シリアル化の動作]** で **[モニカー キー]** オプションが `true` に設定されているドメイン プロパティがターゲット クラスにある場合に使用されます。 この例では、ドメイン クラス "Album" と "Song" でドメイン プロパティ "Title" に対してこのオプションが設定されています。

修飾キー モニカーは、ID モニカーよりも読みやすくなります。 モデル ファイルの XML をユーザーが読み取る場合は、修飾キー モニカーの使用を検討します。 ただし、ユーザーは複数の要素に同じモニカー キーを設定できます。 重複するキーが原因で、ファイルが正しく再度読み込みされない可能性があります。 したがって、修飾キー モニカーを使用して参照されるドメイン クラスを定義する場合は、重複するモニカーがあるファイルをユーザーが保存できないようにする方法を検討する必要があります。

### <a name="to-set-a-domain-class-to-be-referenced-by-id-monikers"></a>ID モニカーによって参照されるようにドメイン クラスを設定するには

1. クラスとその基本クラスのすべてのドメイン プロパティに対して **[モニカー キー]** が `false` であることを確認します。

    1. DSL エクスプローラーで、 **[XML シリアル化の動作]\[クラス データ]\\\<the domain class>\[要素データ]** を展開します。

    2. すべてのドメイン プロパティに対して **[モニカー キー]** が `false` であることを確認します。

    3. ドメイン クラスに基本クラスがある場合は、そのクラスで手順を繰り返します。

2. ドメイン クラスで **[シリアル化 ID]**  = `true` を設定します。

     このプロパティは、 **[XML シリアル化の動作]** の下にあります。

### <a name="to-set-a-domain-class-to-be-referenced-by-qualified-key-monikers"></a>修飾キー モニカーによって参照されるようにドメイン クラスを設定するには

- 既存のドメイン クラスのドメイン プロパティに対して **[モニカー キー]** を設定します。 プロパティの型は `string` にする必要があります。

    1. DSL エクスプローラーで、 **[XML シリアル化の動作]\[クラス データ]\\\<the domain class>\[要素データ]** を展開し、ドメイン プロパティを選択します。

    2. [プロパティ] ウィンドウで、 **[モニカー キー]** を `true` に設定します。

- \- または

     **[名前付きドメイン クラス]** ツールを使用して、新しいドメイン クラスを作成します。

     このツールでは、ドメイン プロパティ Name を持つ新しいクラスを作成します。 このドメイン プロパティの **[要素名]** と **[モニカー キー]** プロパティは `true` に初期化されます。

- \- または

     ドメイン クラスから、モニカー キー プロパティを持つ別のクラスへの継承リレーションシップを作成します。

### <a name="avoid-duplicate-monikers"></a>モニカーが重複しないようにする

修飾キー モニカーを使用する場合、ユーザーのモデル内にある 2 つの要素がキー プロパティで同じ値を持つ可能性があります。 たとえば、DSL にプロパティ Name を持つクラス Person がある場合、ユーザーが 2 つの要素の Name を同じものに設定する可能性があります。 モデルをファイルに保存できても、正しく再読み込みされません。

このような状況を回避するために、いくつかの方法があります。

- キー ドメイン プロパティで **[要素名]**  = `true` に設定します。 DSL 定義図でドメイン プロパティを選択し、プロパティウィンドウで値を設定します。

     ユーザーがクラスの新しいインスタンスを作成すると、この値が原因で、そのドメイン プロパティに別の値が自動的に割り当てられます。 既定の動作では、クラス名の末尾に数値が追加されます。 これにより、ユーザーが名前を重複するものに変更するのを防ぐことはできませんが、モデルを保存する前にユーザーが値を設定していない場合に役立ちます。

- DSL の検証を有効にします。 DSL エクスプローラーで、[エディター]\[検証] を選択し、 **[使用]** プロパティを `true` に設定します。

     自動的に生成され、あいまいさをチェックする検証メソッドがあります。 このメソッドは、`Load` 検証カテゴリにあります。 これにより、ファイルを再度開くことができない可能性があるという警告がユーザーに表示されるようになります。

     詳細については、「[ドメイン固有言語における検証](../modeling/validation-in-a-domain-specific-language.md)」を参照してください。

### <a name="moniker-paths-and-qualifiers"></a>モニカーのパスと修飾子

修飾キー モニカーは、モニカー キーで終了し、埋め込みツリーにおける親のモニカーがプレフィックスとして付けられます。 たとえば、Album のモニカーが次のようになっているとします。

```xml
<albumMoniker title="/My Favorites/Jazz after Teatime" />
```

このとき、その Album 内にある Song の 1 つは、次のようになります。

```xml
<songMoniker title="/My Favorites/Jazz after Teatime/Hot tea" />
```

ただし、Album が代わりに ID で参照される場合、モニカーは次のようになります。

```xml
<albumMoniker Id="77472c3a-9bf9-4085-976a-d97a4745237c" />
<songMoniker title="/77472c3a-9bf9-4085-976a-d97a4745237c/Hot tea" />
```

GUID は一意であるため、その親のモニカーがプレフィックスとして付かないことに注意してください。

特定のドメイン プロパティにモデル内で常に一意の値が使用されることがわかっている場合は、そのプロパティに対して **[モニカー修飾子]** を `true` に設定できます。 これにより、修飾子として使用され、親のモニカーを使用せずに済みます。 たとえば、Album クラスの Title ドメイン プロパティに対して、 **[モニカー修飾子]** と **[モニカー キー]** の両方を設定した場合、Album とその埋め込み子のモニカーでは、モデルの名前または識別子が使用されません。

```xml
<albumMoniker name="Jazz after Teatime" />
<songMoniker title="/Jazz after Teatime/Hot tea" />
```

## <a name="customize-the-structure-of-the-xml"></a>XML 構造をカスタマイズする

次のカスタマイズを行うには、DSL エクスプローラーで **[XML シリアル化の動作]** ノードを展開します。 ドメイン クラスの下で、[要素データ] ノードを展開し、このクラスでソースとなるプロパティとリレーションシップの一覧を表示します。 リレーションシップを選択し、そのオプションを [プロパティ] ウィンドウで調整します。

- ターゲット要素の一覧だけを残して、ソース ロール ノードを省略するには、 **[要素の省略]** を true に設定します。 ソースとターゲットのクラスの間に複数のリレーションシップがある場合は、このオプションを設定しないでください。

    ```xml
    <familyTreeModel ...>
      <!-- The following node is omitted by using Omit Element: -->
      <!-- <people> -->
        <person name="Henry VIII" .../>
        <person name="Elizabeth I" .../>
      <!-- </people> -->
    </familyTreeModel>
    ```

- リレーションシップ インスタンスを表すノードにターゲット ノードを埋め込むには、 **[完全なフォームを使用]** を設定します。 ドメイン リレーションシップにドメイン プロパティを追加すると、このオプションは自動的に設定されます。

    ```xml
    <familyTreeModel ...>
      <people>
        <!-- The following node is inserted by using Use Full Form: -->
        <familyTreeModelHasPeople myRelationshipProperty="x1">
          <person name="Henry VIII" .../>
        </familyTreeModelHasPeople>
        <familyTreeModelHasPeople myRelationshipProperty="x2">
          <person name="Elizabeth I" .../>
        </familyTreeModelHasPeople>
      </people>
    </familyTreeModel>
    ```

- 属性値としてではなく、要素として保存されたドメイン プロパティを持つには、 **[表現]**  =  **[要素]** に設定します。

    ```xml
    <person name="Elizabeth I" birthYear="1533">
      <deathYear>1603</deathYear>
    </person>
    ```

- 属性およびリレーションシップをシリアル化する順序を変更するには、[要素データ] の下の項目を右クリックし、 **[上へ移動]** または **[下へ移動]** メニュー コマンドを使用します。

## <a name="major-customization-using-program-code"></a>プログラム コードを使用した大規模なカスタマイズ

一部またはすべてのシリアル化アルゴリズムを置き換えることができます。

**Dsl\Generated Code\Serializer.cs** と **SerializationHelper.cs** のコードを学習することをお勧めします。

### <a name="to-customize-the-serialization-of-a-particular-class"></a>特定のクラスのシリアル化をカスタマイズするには

1. **[XML シリアル化の動作]** の下で、そのクラスのノードの **[カスタム]** を設定します。

2. すべてのテンプレートを変換し、ソリューションをビルドして、生成されたコンパイル エラーを調査します。 それぞれのエラーの近くにあるコメントでは、どのようなコードを提供する必要があるかを説明します。

### <a name="to-provide-your-own-serialization-for-the-whole-model"></a>モデル全体に独自のシリアル化を提供するには

1. Dsl\GeneratedCode\SerializationHelper.cs でメソッドをオーバーライドします。

## <a name="options-in-xml-serialization-behavior"></a>XML シリアル化の動作のオプション

DSL エクスプローラーの [XML シリアル化の動作] ノードには、ドメイン クラス、リレーションシップ、シェイプ、コネクタ、図のクラスごとに、子ノードが含まれています。 これらの各ノードの下には、その要素でソースとなるプロパティとリレーションシップの一覧が表示されます。 リレーションシップは、独自の権限内とソース クラスの下の両方で表現されます。

次の表は、DSL 定義のこのセクションで設定できるオプションをまとめたものです。 どちらの場合も、DSL エクスプローラーで要素を選択し、[プロパティ] ウィンドウでオプションを設定します。

### <a name="xml-class-data"></a>XML クラス データ

これらの要素は、DSL エクスプローラーの **[XML シリアル化の動作]\[クラス データ]** にあります。

|プロパティ|説明|
|-|-|
|カスタム要素スキーマを含む|True の場合、ドメイン クラスにカスタム要素スキーマがあることを示します。|
|カスタム|このドメイン クラスに対して独自のシリアル化および逆シリアル化コードを記述する場合は、これを **True** に設定します。<br /><br /> ソリューションをビルドし、エラーを調査して、詳細な手順を見つけます。|
|ドメイン クラス|このクラス データ ノードが適用されるドメイン クラス。 読み取り専用です。|
|要素名|このクラスの要素の XML ノード名。 既定値は、ドメイン クラス名の小文字バージョンです。|
|モニカー属性名|参照を格納するためにモニカー要素で使用される属性の名前。 空白の場合は、キー プロパティまたは ID の名前が使用されます。<br /><br /> この例では、"name" です。`<personMoniker name="/Mike Nash"/>`|
|モニカー要素名|このクラスの要素を参照するモニカーに使用する XML 要素の名前。<br /><br /> 既定値は、"Moniker" というサフィックスが付けられた、クラス名の小文字バージョンです。 たとえば、「 `personMoniker` 」のように入力します。|
|モニカーの型名|このクラスの要素に対してモニカー用に生成される XSD 型の名前。 XSD は、**Dsl\Generated Code\\\*Schema.xsd** にあります。|
|シリアル化 ID|True の場合、要素の GUID はファイルに含まれます。 **[モニカー キー]** がマークされたプロパティがなく、DSL がこのクラスへの参照リレーションシップを定義している場合は、この値が true である必要があります。|
|種類名|指定したドメイン クラスからの XSD で生成される XML 型の名前。|
|Notes|この要素に関連付けられた非公式のメモ。|

### <a name="xml-property-data"></a>XML プロパティ データ

XML プロパティ ノードは、クラス ノードの下にあります。

|プロパティ|説明|
|-|-|
|ドメイン プロパティ|XML シリアル化の構成データが適用されるプロパティ。 読み取り専用です。|
|モニカー キー|True の場合、このドメイン クラスのインスタンスを参照するモニカーを作成するためのキーとして、プロパティが使用されます。|
|モニカー修飾子|True の場合、プロパティはモニカーの修飾子を作成するために使用されます。 false の場合、およびこのドメイン クラスの SerializeId が true でない場合、モニカーは埋め込みツリー内の親要素のモニカーによって修飾されます。|
|[表記]|[属性] の場合、プロパティは XML 属性としてシリアル化されます。[要素] の場合、要素としてシリアル化されます。[無視] の場合はシリアル化されません。|
|XML 名|プロパティを表す XML 属性または要素に使用される名前。 既定では、これはドメイン プロパティ名の小文字バージョンです。|
|Notes|この要素に関連付けられた非公式のメモ。|

### <a name="xml-role-data"></a>XML ロール データ

ロール データ ノードは、ソース クラス ノードの下にあります。

|プロパティ|説明|
|-|-|
|カスタム モニカーを含む|このリレーションシップを走査するモニカーを生成および解決するための独自コードを指定する場合は、これを true に設定します。<br /><br /> 詳細な手順については、ソリューションをビルドし、エラー メッセージをダブルクリックしてください。|
|ドメイン リレーションシップ|これらのオプションが適用されるリレーションシップを指定します。 読み取り専用です。|
|要素の省略|true の場合、ソース ロールに対応する XML ノードはスキーマから省略されます。<br /><br /> ソースとターゲットのクラスの間に複数のリレーションシップがある場合、このロール ノードによって、2 つのリレーションシップに属するリンクを区別します。 したがって、この場合はこのオプションを設定しないことをお勧めします。|
|ロール要素名|ソース ロールから派生した XML 要素の名前を指定します。 既定値は、ロール プロパティ名です。|
|完全なフォームを使用|true の場合、各ターゲット要素またはモニカーは、リレーションシップを表す XML ノードで囲まれます。 リレーションシップに独自のドメイン プロパティがある場合は、これを true に設定する必要があります。|

## <a name="see-also"></a>関連項目

- [プログラム コードにおけるモデル内の移動およびモデルの更新](../modeling/navigating-and-updating-a-model-in-program-code.md)
- [ドメイン固有言語からのコード生成](../modeling/generating-code-from-a-domain-specific-language.md)
