---
title: ファイル格納処理および XML シリアル化処理のカスタマイズ
ms.date: 11/04/2016
ms.topic: how-to
f1_keywords:
- vs.dsltools.dsldesigner.xmlbehavior
helpviewer_keywords:
- Domain-Specific Language, serialization
author: JoshuaPartlow
ms.author: joshuapa
manager: jillfra
ms.workload:
- multiple
ms.openlocfilehash: 07592247e0afb870f3c4774c6f2023a6e8141cd1
ms.sourcegitcommit: 6cfffa72af599a9d667249caaaa411bb28ea69fd
ms.translationtype: MT
ms.contentlocale: ja-JP
ms.lasthandoff: 09/02/2020
ms.locfileid: "85542741"
---
# <a name="customize-file-storage-and-xml-serialization"></a>ファイル格納処理および XML シリアル化処理をカスタマイズする

ユーザーが Visual Studio でドメイン固有言語 (DSL) のインスタンスまたは *モデル*を保存すると、XML ファイルが作成または更新されます。 ファイルを再度読み込んで、ストアにモデルを再作成することができます。

DSL エクスプローラーで [ **Xml シリアル化の動作** ] の設定を調整することで、シリアル化スキームをカスタマイズできます。 各ドメインクラス、プロパティ、およびリレーションシップについて、 **Xml シリアル化の動作** の下にノードがあります。 リレーションシップは、ソースクラスの下に配置されます。 図形、コネクタ、および図クラスに対応するノードもあります。

さらに高度なカスタマイズのためのプログラムコードを記述することもできます。

> [!NOTE]
> 特定の形式でモデルを保存するが、そのフォームから再読み込みを行う必要がない場合は、カスタムのシリアル化スキームではなく、テキストテンプレートを使用してモデルからの出力を生成することを検討してください。 詳細については、「 [ドメイン固有言語からコードを生成する](../modeling/generating-code-from-a-domain-specific-language.md)」を参照してください。

## <a name="model-and-diagram-files"></a>モデルと図のファイル

各モデルは通常、次の2つのファイルに保存されます。

- モデルファイルには、 **Model1**などの名前が付けられています。 モデル要素、リレーションシップ、およびそのプロパティが格納されます。 **Mydsl**などのファイル拡張子は、DSL 定義の**エディター**ノードの**fileextension**プロパティによって決定されます。

- ダイアグラムファイルには、 **Model1**などの名前が付けられています。 図形、コネクタ、その位置、色、線の太さ、および図の外観のその他の詳細が格納されます。 ユーザーが **ダイアグラム** ファイルを削除した場合、モデル内の重要な情報は失われません。 図のレイアウトだけが失われます。 モデルファイルを開くと、既定の図形とコネクタのセットが作成されます。

### <a name="to-change-the-file-extension-of-a-dsl"></a>DSL のファイル拡張子を変更するには

1. DSL 定義を開きます。 DSL エクスプローラーで、[エディター] ノードをクリックします。

2. プロパティウィンドウで、 **Fileextension** プロパティを編集します。 ファイル名拡張子の最初の "." を含めないでください。

3. ソリューションエクスプローラーで、 **DslPackage\ProjectItemTemplates**内の2つの項目テンプレートファイルの名前を変更します。 これらのファイルには、次の形式の名前が付いています。

     `myDsl.diagram`

     `myDsl.myDsl`

## <a name="the-default-serialization-scheme"></a>既定のシリアル化スキーム

このトピックの例を作成するには、次の DSL 定義が使用されています。

![DSL 定義図 &#45; ファミリツリーモデル](../modeling/media/familyt_person.png)

この DSL を使用して、画面上に次のような外観のモデルを作成しました。

![ファミリ ツリー ダイアグラム、ツールボックス、およびエクスプローラー](../modeling/media/familyt_instance.png)

このモデルは、次のように保存され、XML テキストエディターで再び開かれました。

```xml
<?xml version="1.0" encoding="utf-8"?>
<familyTreeModel xmlns:dm0="http://schemas.microsoft.com/VisualStudio/2008/DslTools/Core" dslVersion="1.0.0.0" Id="f817b728-e920-458e-bb99-98edc469d78f" xmlns="http://schemas.microsoft.com/dsltools/FamilyTree">
  <people>
    <person name="Henry VIII" birthYear="1491" deathYear="1547" age="519">
      <children>
        <personMoniker name="/f817b728-e920-458e-bb99-98edc469d78f/Elizabeth I" />
        <personMoniker name="/f817b728-e920-458e-bb99-98edc469d78f/Mary" />
      </children>
    </person>
    <person name="Elizabeth I" birthYear="1533" deathYear="1603" age="477" />
    <person name="Mary" birthYear="1515" deathYear="1558" age="495" />
  </people>
</familyTreeModel>
```

シリアル化されたモデルについては、次の点に注意してください。

- 各 XML ノードにはドメインクラス名と同じ名前が付けられますが、最初の文字は小文字である点が異なります。 たとえば、`familyTreeModel` や `person`す。

- Name や BirthYear などのドメインプロパティは、XML ノードの属性としてシリアル化されます。 ここでも、プロパティ名の最初の文字が小文字に変換されます。

- 各リレーションシップは、リレーションシップのソースエンド内に入れ子になった XML ノードとしてシリアル化されます。 ノードの名前は、ソースロールプロパティと同じですが、小文字の初期文字が使用されています。

     たとえば、DSL 定義では、 **People** という名前のロールは **FamilyTree** クラスをソースとしています。  XML では、これはノード内に入れ子にされたという名前のノードによって表され `people` `familyTreeModel` ます。

- 各埋め込みリレーションシップのターゲットエンドは、リレーションシップの下に入れ子になったノードとしてシリアル化されます。 たとえば、ノードに `people` 複数のノードが含まれているとし `person` ます。

- 各参照リレーションシップのターゲットエンドは、ターゲット要素への参照をエンコードする *モニカー*としてシリアル化されます。

     たとえば、ノードの下にリレーションシップが存在する場合が `person` あり `children` ます。 このノードには、次のようなモニカーが含まれています。

    ```xml
    <personMoniker name="/f817b728-e920-458e-bb99-98edc469d78f/Elizabeth I" />
    ```

## <a name="understand-monikers"></a>モニカーについて

モニカーは、モデルファイルと図ファイルの異なる部分の間の相互参照を表すために使用されます。 また、モデルファイル内の `.diagram` ノードを参照するためにファイルでも使用されます。 モニカーには、次の2つの形式があります。

- *Id モニカー* ターゲット要素の GUID を引用します。 次に例を示します。

    ```xml
    <personShapeMoniker Id="f79734c0-3da1-4d72-9514-848fa9e75157" />
    ```

- *修飾キーモニカー* は、モニカーキーと呼ばれる指定されたドメインプロパティの値によってターゲット要素を識別します。 ターゲット要素のモニカーには、埋め込みリレーションシップのツリー内の親要素のモニカーがプレフィックスとして付けられます。

     次の例は、"楽曲" という名前のドメインクラスへの埋め込みリレーションシップを持つ、"アルバム" という名前のドメインクラスがある DSL から取得されています。

    ```xml
    <albumMoniker title="/My Favorites/Jazz after Teatime" />
    <songMoniker title="/My Favorites/Jazz after Teatime/Hot tea" />
    ```

     修飾キーモニカーが使用されるのは、ターゲットクラスに [ **モニカーキー** ] が `true` [ **Xml シリアル化動作**中] に設定されているドメインプロパティがある場合です。 この例では、ドメインクラス "アルバム" と "Song" の "Title" という名前のドメインプロパティに対してこのオプションを設定しています。

修飾キーモニカーは、ID モニカーよりも読みやすくなります。 モデルファイルの XML をユーザーが読み取る場合は、修飾キーモニカーの使用を検討してください。 ただし、ユーザーは複数の要素に同じモニカーキーを設定することができます。 重複するキーが原因で、ファイルが正しく再読み込みされない可能性があります。 したがって、修飾キーモニカーを使用して参照されるドメインクラスを定義する場合は、モニカーが重複しているファイルをユーザーが保存できないようにする方法を検討する必要があります。

### <a name="to-set-a-domain-class-to-be-referenced-by-id-monikers"></a>ID モニカーによって参照されるようにドメインクラスを設定するには

1. クラスとその基本クラスのすべてのドメインプロパティに対して [ **モニカーキー** ] がになっていることを確認し `false` ます。

    1. DSL エクスプローラーで、[ **Xml シリアル化] [クラスデータ]、[ \\ \<the domain class> 要素データ**] の順に展開します。

    2. **Is モニカーキー**が `false` すべてのドメインプロパティに対してであることを確認します。

    3. ドメインクラスに基底クラスがある場合は、そのクラスのプロシージャを繰り返します。

2. ドメインクラスの**シリアル化 Id**  =  `true` を設定します。

     このプロパティは、[ **Xml シリアル化の動作**] の下にあります。

### <a name="to-set-a-domain-class-to-be-referenced-by-qualified-key-monikers"></a>修飾キーモニカーによって参照されるようにドメインクラスを設定するには

- Set は、既存のドメインクラスのドメインプロパティの **モニカーキー** です。 プロパティの型はである必要があり `string` ます。

    1. DSL エクスプローラーで、[ **Xml シリアル化] [クラスデータ]、[ \\ \<the domain class> 要素データ**] の順に展開し、[ドメイン] プロパティを選択します。

    2. プロパティウィンドウで、[ **モニカーキー** ] をに設定 `true` します。

- \- または

     **名前付きドメインクラス**ツールを使用して、新しいドメインクラスを作成します。

     このツールは、Name という名前のドメインプロパティを持つ新しいクラスを作成します。 は **要素名** で、このドメインプロパティの **モニカーキー** プロパティはに初期化され `true` ます。

- \- または

     ドメインクラスから、モニカーキープロパティを持つ別のクラスへの継承リレーションシップを作成します。

### <a name="avoid-duplicate-monikers"></a>モニカーが重複しないようにする

修飾キーモニカーを使用する場合、ユーザーのモデル内の2つの要素がキープロパティで同じ値を持つ可能性があります。 たとえば、DSL にプロパティ名を持つクラスがある場合、ユーザーは2つの要素の名前を同じに設定できます。 モデルをファイルに保存することもできますが、正しく再読み込みされません。

このような状況を回避するために、いくつかの方法があります。

- Set**は**  =  `true` 、キードメインプロパティの要素名です。 DSL 定義図の [ドメイン] プロパティを選択し、プロパティウィンドウの値を設定します。

     ユーザーがクラスの新しいインスタンスを作成すると、この値によってドメインプロパティに別の値が自動的に割り当てられます。 既定の動作では、クラス名の末尾に数値が追加されます。 これにより、ユーザーが名前を重複に変更するのを防ぐことはできませんが、モデルを保存する前にユーザーが値を設定していない場合に役立ちます。

- DSL の検証を有効にします。 DSL エクスプローラーで、[Editor\ Validation] を選択し、[ **使用** ] プロパティを `true` に設定します。

     あいまいさをチェックする、自動的に生成された検証メソッドがあります。 メソッドは、 `Load` 検証カテゴリにあります。 これにより、ファイルを再度開くことができないという警告がユーザーに表示されるようになります。

     詳細については、「 [ドメイン固有言語での検証](../modeling/validation-in-a-domain-specific-language.md)」を参照してください。

### <a name="moniker-paths-and-qualifiers"></a>モニカーのパスと修飾子

修飾キーモニカーは、モニカーキーで終了し、埋め込みツリー内の親のモニカーがプレフィックスとして付けられます。 たとえば、アルバムのモニカーが次のようになっているとします。

```xml
<albumMoniker title="/My Favorites/Jazz after Teatime" />
```

そのアルバムの曲の1つは、次のようになります。

```xml
<songMoniker title="/My Favorites/Jazz after Teatime/Hot tea" />
```

ただし、代わりに ID でアルバムが参照されている場合、モニカーは次のようになります。

```xml
<albumMoniker Id="77472c3a-9bf9-4085-976a-d97a4745237c" />
<songMoniker title="/77472c3a-9bf9-4085-976a-d97a4745237c/Hot tea" />
```

GUID は一意であるため、その親のモニカーにプレフィックスが付いていないことに注意してください。

特定のドメインプロパティのモデル内で常に一意の値が使用されていることがわかっている場合は、そのプロパティに対して " **モニカーの修飾子** " をに設定でき `true` ます。 これにより、親のモニカーを使用せずに、修飾子として使用されます。 たとえば、" **モニカーの修飾子** " と "アルバム" クラスの "タイトルドメイン" プロパティの " **モニカーキー** " の両方を設定した場合、モデルの名前または識別子は、アルバムとその埋め込み子のモニカーでは使用されません。

```xml
<albumMoniker name="Jazz after Teatime" />
<songMoniker title="/Jazz after Teatime/Hot tea" />
```

## <a name="customize-the-structure-of-the-xml"></a>XML の構造のカスタマイズ

次のカスタマイズを行うには、DSL エクスプローラーで [ **Xml シリアル化の動作** ] ノードを展開します。 ドメインクラスの下で、[要素データ] ノードを展開して、このクラスでソースとなるプロパティとリレーションシップの一覧を表示します。 リレーションシップを選択し、そのオプションをプロパティウィンドウで調整します。

- Target 要素のリストだけを残して、ソースロールノードを省略するには、[ **省略要素** ] を true に設定します。 ソースクラスとターゲットクラスの間に複数のリレーションシップがある場合は、このオプションを設定しないでください。

    ```xml
    <familyTreeModel ...>
      <!-- The following node is omitted by using Omit Element: -->
      <!-- <people> -->
        <person name="Henry VIII" .../>
        <person name="Elizabeth I" .../>
      <!-- </people> -->
    </familyTreeModel>
    ```

- リレーションシップインスタンスを表すノードにターゲットノードを埋め込むには、[ **完全なフォームを使用** する。 ドメインリレーションシップにドメインプロパティを追加すると、このオプションは自動的に設定されます。

    ```xml
    <familyTreeModel ...>
      <people>
        <!-- The following node is inserted by using Use Full Form: -->
        <familyTreeModelHasPeople myRelationshipProperty="x1">
          <person name="Henry VIII" .../>
        </familyTreeModelHasPeople>
        <familyTreeModelHasPeople myRelationshipProperty="x2">
          <person name="Elizabeth I" .../>
        </familyTreeModelHasPeople>
      </people>
    </familyTreeModel>
    ```

- **Representation**  =  属性値としてではなく、要素として保存されたドメインプロパティを持つように表現**要素**を設定します。

    ```xml
    <person name="Elizabeth I" birthYear="1533">
      <deathYear>1603</deathYear>
    </person>
    ```

- 属性およびリレーションシップをシリアル化する順序を変更するには、[要素データ] の下の項目を右クリックし、[ **上へ移動** ] または [ **下へ移動** ] メニューコマンドを使用します。

## <a name="major-customization-using-program-code"></a>プログラムコードを使用した大規模なカスタマイズ

一部またはすべてのシリアル化アルゴリズムを置き換えることができます。

**Code\Serializer.cs**と**SerializationHelper.cs**のコードを確認することをお勧めします。

### <a name="to-customize-the-serialization-of-a-particular-class"></a>特定のクラスのシリアル化をカスタマイズするには

1. [ **Xml シリアル化の動作**] の下にあるそのクラスのノードでは、[**カスタム] が設定され**ています。

2. すべてのテンプレートを変換し、ソリューションをビルドして、生成されたコンパイルエラーを調査します。 各エラーの近くにあるコメントは、どのようなコードを提供する必要があるかを説明します。

### <a name="to-provide-your-own-serialization-for-the-whole-model"></a>モデル全体に独自のシリアル化を提供するには

1. Dslbase でメソッドをオーバーライドします。

## <a name="options-in-xml-serialization-behavior"></a>Xml シリアル化の動作のオプション

DSL エクスプローラーで、[Xml シリアル化動作] ノードには、各ドメインクラス、リレーションシップ、図形、コネクタ、および図クラスの子ノードが含まれています。 これらの各ノードの下には、その要素でソースとなるプロパティとリレーションシップの一覧が表示されます。 リレーションシップは、独自の権限とソースクラスの両方で表されます。

次の表は、DSL 定義のこのセクションで設定できるオプションをまとめたものです。 どちらの場合も、DSL エクスプローラーで要素を選択し、プロパティウィンドウのオプションを設定します。

### <a name="xml-class-data"></a>Xml クラスデータ

これらの要素は、DSL エクスプローラーの [ **Xml シリアル化] [クラスデータ**] にあります。

|プロパティ|説明|
|-|-|
|カスタム要素スキーマがある|True の場合、ドメインクラスにカスタム要素スキーマがあることを示します。|
|カスタム|このドメインクラスの独自のシリアル化および逆シリアル化コードを記述する場合は、 **True** に設定します。<br /><br /> ソリューションをビルドし、エラーを調査して詳細な手順を見つけます。|
|ドメイン クラス|このクラスのデータノードが適用されるドメインクラス。 読み取り専用。|
|要素名|このクラスの要素の Xml ノード名。 既定値は、ドメインクラス名の小文字のバージョンです。|
|モニカー属性名|参照を格納するためにモニカー要素で使用される属性の名前。 空白の場合は、キープロパティまたは id の名前が使用されます。<br /><br /> この例では、"name" になります。  `<personMoniker name="/Mike Nash"/>`|
|モニカー要素名|このクラスの要素を参照するモニカーに使用される xml 要素の名前。<br /><br /> 既定値は、"モニカー" でサフィックスが付けられた、小文字バージョンのクラス名です。 たとえば、「 `personMoniker` 」のように入力します。|
|モニカーの種類名|このクラスの要素に対してモニカー用に生成される xsd 型の名前。 XSD は、**生成されたコード \\ \* スキーマ .xsd**に含まれています。|
|シリアル化 Id|True の場合、要素の GUID はファイルに含まれます。 " **モニカーキー** " とマークされたプロパティがなく、DSL がこのクラスへの参照リレーションシップを定義している場合は、この値が true である必要があります。|
|種類名|指定されたドメインクラスから xsd で生成される xml 型の名前。|
|Notes|この要素に関連付けられた非公式のメモ|

### <a name="xml-property-data"></a>Xml プロパティデータ

Xml プロパティノードは、クラスノードの下にあります。

|プロパティ|説明|
|-|-|
|ドメインプロパティ|Xml シリアル化の構成データが適用されるプロパティ。 読み取り専用。|
|モニカーキー|True の場合、このドメインクラスのインスタンスを参照するモニカーを作成するためのキーとして、プロパティが使用されます。|
|モニカー修飾子|True の場合、プロパティはモニカーの修飾子を作成するために使用されます。 False の場合、このドメインクラスの SerializeId が true でない場合、モニカーは埋め込みツリー内の親要素のモニカーによって修飾されます。|
|[表記]|属性の場合、プロパティは xml 属性としてシリアル化されます。要素の場合、要素としてシリアル化されます。Ignore の場合、シリアル化されません。|
|Xml 名|プロパティを表す xml 属性または要素に使用される名前。 既定では、これはドメインプロパティ名の小文字のバージョンです。|
|Notes|この要素に関連付けられた非公式のメモ|

### <a name="xml-role-data"></a>Xml ロールデータ

ロールデータノードは、[ソースクラス] ノードの下にあります。

|プロパティ|説明|
|-|-|
|カスタムモニカーがある|このリレーションシップを走査するモニカーを生成して解決するための独自のコードを指定する場合は、true に設定します。<br /><br /> 詳細な手順については、ソリューションをビルドし、エラーメッセージをダブルクリックします。|
|ドメイン リレーションシップ|これらのオプションが適用されるリレーションシップを指定します。 読み取り専用。|
|要素の省略|True の場合、ソースロールに対応する XML ノードはスキーマから除外されます。<br /><br /> ソースクラスとターゲットクラスの間に複数のリレーションシップがある場合、このロールノードは、2つのリレーションシップに属するリンクを区別します。 したがって、この場合はこのオプションを設定しないことをお勧めします。|
|ロール要素名|ソースロールから派生した XML 要素の名前を指定します。 既定値は、ロールのプロパティ名です。|
|完全なフォームを使用する|True の場合、各ターゲット要素またはモニカーは、リレーションシップを表す XML ノードで囲まれます。 リレーションシップに独自のドメインプロパティがある場合は、これを true に設定する必要があります。|

## <a name="see-also"></a>関連項目

- [プログラム コードにおけるモデル内の移動およびモデルの更新](../modeling/navigating-and-updating-a-model-in-program-code.md)
- [ドメイン固有言語からのコード生成](../modeling/generating-code-from-a-domain-specific-language.md)
