---
title: 同時実行ビジュアライザーのスレッド ビュー | Microsoft Docs
ms.date: 11/04/2018
ms.topic: conceptual
f1_keywords:
- vs.performance.view.threadblocking
helpviewer_keywords:
- Concurrency Visualizer, Threads View (Parallel Performance)
ms.assetid: 2e441103-a266-407b-88c3-fb58716257a3
author: mikejo5000
ms.author: mikejo
manager: jillfra
ms.workload:
- multiple
ms.openlocfilehash: 4382a21a68848a758f3d4cd37a8528722927691c
ms.sourcegitcommit: cc841df335d1d22d281871fe41e74238d2fc52a6
ms.translationtype: HT
ms.contentlocale: ja-JP
ms.lasthandoff: 03/18/2020
ms.locfileid: "62973756"
---
# <a name="threads-view-in-the-concurrency-visualizer"></a>同時実行ビジュアライザーのスレッド ビュー

**スレッド** ビューは、同時実行ビジュアライザーの最も詳細かつ機能豊富なビューです。 **スレッド** ビューでは、実行セグメント中にコードを実行しているスレッドを特定したり、スレッドが実行されているのか、それとも同期、I/O、その他の理由からブロックされているのか分析したりできます。 **スレッド** ビューのレポートではまた、呼び出し履歴ツリーの実行やブロック解除スレッドがプロファイルされます。

スレッドの実行中、同時実行ビジュアライザーによってサンプルが収集されます。 スレッドの実行が停止すると、ビジュアライザーによって、そのスレッドに対するオペレーティング システムのコンテキスト スイッチ イベントがすべて調べられます。 コンテキスト スイッチが発生する理由:

- 同期プリミティブでスレッドがブロックされた。
- スレッドのクォンタムの期限が切れた。
- スレッドがブロックの原因となる I/O 要求を実行した。

同時実行ビジュアライザーでは、スレッドとコンテキスト スイッチ イベントが分類され、スレッドの呼び出し履歴から既知のブロッキング API が検索されます。 **スレッド** ビューの左下にあるアクティブな凡例にスレッド カテゴリが表示されます。 多くの場合、コンテキストの切り替えイベントに対応する呼び出し履歴を調べることにより、ブロック イベントの根本原因を識別できます。

呼び出し履歴に一致するものがない場合、同時実行ビジュアライザーでは、[!INCLUDE[TLA#tla_mswin](../code-quality/includes/tlasharptla_mswin_md.md)] から表示される待機理由が使用されます。 ただし、[!INCLUDE[TLA#tla_mswin](../code-quality/includes/tlasharptla_mswin_md.md)] のカテゴリは実装の詳細に基づく場合があり、ユーザーの意図を反映しない可能性があります。 たとえば [!INCLUDE[TLA#tla_mswin](../code-quality/includes/tlasharptla_mswin_md.md)] は、ネイティブのスリム リーダー/ ライター ロックでのブロックの待機理由を、同期ではなく I/O として報告します。

**スレッド** ビューでは、スレッド間の依存関係も示します。 たとえば、同期オブジェクトでブロックされているスレッドを特定した場合、そのブロックを解除したスレッドを見つけることができます。 他方のブロックを解除した時点で、呼び出し履歴からブロック解除スレッドを調べることができます。

**スレッド** ビューは次の目的で使用できます。

- アプリのユーザー インターフェイス (UI) が特定の実行フェーズ中に応答しない理由を特定します。
- 同期、I/O、ページ フォールト、その他のイベントでのブロックに費やされた時間を決定します。
- システム上で実行される他のプロセスからの干渉の程度を明らかにします。
- 並列実行に関する負荷分散の問題を識別します。
- 最適な拡張性が得られない、あるいは拡張性がまったくない理由を見つけます。 たとえば、論理コアを追加できるときに、並列アプリのパフォーマンスが改善されない理由です。
- アプリケーションでのコンカレンシーの程度を理解し、並列処理に役立てることができます。
- ワーカー スレッドと実行のクリティカル パスの間の依存関係を特定します。

## <a name="use-threads-view"></a>スレッド ビューを使用する

同時実行ビジュアライザーを開始するには、 **[分析]** 、 **[同時実行ビジュアライザー]** の順に選択し、 **[Launch New Process]\(新しいプロセスの起動\)** など、オプションを選択します。

同時実行ビジュアライザーによってアプリが開始され、 **[コレクションの停止]** を選択するまでトレースが収集されます。 次に、ビジュアライザーによってトレースが分析され、トレース レポート ページに結果が表示されます。

レポートの左上にある **[スレッド]** タブを選択し、 **[スレッド]** ビューを開きます。

![スレッド ビュー](../profiling/media/threadsviewnarrowing.png "スレッド ビュー")

時間とスレッドを選択し、パフォーマンス分析を開始します。

## <a name="timeline-analysis"></a>タイムライン分析

**スレッド** ビューの上部はタイムラインです。 タイムラインは、プロセス内のすべてのスレッドのアクティビティと、ホスト コンピューター上のすべての物理ディスク デバイスを示します。 GPU アクティビティとマーカー イベントも表示されます。

タイムラインでは、x 軸は時間を示し、y 軸は次のようないくつかのチャネルを示します。

- システム上のディスク ドライブごとに 2 つの I/O チャネル。1 つのチャネルは読み取り用で、もう 1 つは書き込み用です。
- プロセス内の各スレッドのチャネル。
- マーカー チャネル (トレースにマーカー イベントがある場合)。 マーカー チャネルは、それらのイベントを生成したスレッド チャネルの下に最初に表示されます。
- GPU チャネル。

最初にスレッドは、メイン アプリ スレッドが先頭になるように、作成された順に並べられます。 **[実行]** など、別の基準でスレッドを並べ替えるには、 **[ファイルの並べ替え]** ドロップダウンで別のオプションを選択します。

タイムラインの色は特定の時点でのスレッドの状態を示します。 緑のセグメントは実行されているもの、赤いセグメントは同期のためにブロックされているもの、黄色のセグメントは優先処理によりブロックされているもの、紫色のセグメントはデバイスの I/O で占有されていているものです。

拡大してさらに詳細な情報を表示したり、縮小して表示する時間間隔を長くしたりできます。 カテゴリ、開始時刻、遅延時間、呼び出し履歴の状態に関する詳細を表示するには、グラフ上でセグメントやポイントを選択します。

タイムラインを使用し、並列ループまたは同時実行タスクに関係しているスレッド間の作業負荷バランスを調べます。 あるスレッドが他のスレッドよりも完了に長い時間がかかっている場合、作業負荷がアンバランスになっている可能性があります。 スレッド間で作業負荷を均等に分散すると、プログラムのパフォーマンスが向上することがあります。

ある時点で実行中のスレッドが 1 つしかない場合、アプリケーションがシステム上のコンカレンシーを十分に活用できていない可能性があります。 タイムラインのグラフを使用して、スレッド間の依存関係や、ブロックの原因となっているスレッドとブロックされるスレッドとのテンポラルな関係を確認できます。 スレッドを再配置するには、スレッドを選択してから、ツール バーで上矢印または下矢印アイコンを選択します。

使われていないスレッドや、統計が無関係で、レポートの邪魔になるために完全にブロックされているスレッドは、非表示にできます。 スレッドは、その名前を選択し、ツール バーで **[選択したスレッドを非表示にします]** アイコンか **[選択したスレッド以外をすべて非表示にします]** アイコンを選択するという手順で非表示にします。 非表示にするスレッドを確認するには、左下にある **[スレッド別の概要]** を選択します。 **[スレッド別の概要]** グラフでアクティビティのないスレッドを非表示にできます。

### <a name="thread-execution-details"></a>スレッド実行の詳細
実行セグメントに関する詳細な情報を取得するには、タイムラインの緑セグメント上にあるポイントを選択します。 同時実行ビジュアライザーによって、選択したポイントの上に黒のキャレットが表示され、一番下のウィンドウの **[現在]** タブにその呼び出し履歴が表示されます。 実行セグメント上の複数のポイントを選択できます。

>[!NOTE]
>セグメントの継続時間が 1 ミリ秒未満の場合、同時実行ビジュアライザーは実行セグメント上の選択を解決できないことがあります。

現在選択されている時間の範囲内で隠されていないすべてのスレッドの実行プロファイルを取得するには、左下にある凡例で **[実行]** を選択します。

### <a name="thread-blocking-details"></a>スレッドのブロックの詳細
スレッドの特定の領域に関する情報を取得するには、タイムライン上でその領域の上にマウス カーソルを置き、ヒントを表示します。 ヒントには、カテゴリ、開始時刻、遅延などの情報が含まれます。 領域を選択すると、一番下のウィンドウの **[現在]** タブにその時点での呼び出し履歴が表示されます。 このウィンドウにはカテゴリと遅延も表示され、ブロック API やブロック解除スレッドが存在する場合、それも表示されます。 呼び出し履歴を確認することにより、スレッドをブロックするイベントの根本原因を確認できます。

実行パスには、いくつかのブロック イベントが含まれることがあります。 こうしたイベントをブロック カテゴリごとに調べ、問題のある領域をより迅速に見つけるには、左側の凡例でブロック カテゴリを選択します。

### <a name="dependencies-between-threads"></a>スレッド間の依存関係
同時実行ビジュアライザーでは、スレッド間の依存関係を確認できます。ブロックされたスレッドが何を実行しようとしていたかや、他のどのスレッドがその実行を可能にしたかを判断できます。

どのスレッドが別のスレッドをブロック解除したのかを確認するには、タイムライン上でブロック セグメントを選択します。 コンカレンシー ビジュアライザーがブロック解除スレッドを判断できた場合、ブロック解除スレッドと、ブロック セグメントに続く実行セグメントが、線で結ばれます。 一番下のウィンドウで **[ブロック解除スタック]** タブを選択すると、関連する呼び出し履歴が表示されます。

## <a name="profile-reports"></a>プロファイル レポート
タイムライン グラフの下のウィンドウには、 **[プロファイル レポート]** 、 **[現在]** 、 **[ブロック解除スタック]** というレポート タブがあります。 タイムラインやスレッドの選択を変更すると、レポートが自動的に更新されます。 大規模なトレースの場合、更新が計算されている間はレポート ウィンドウを一時的に利用できないことがあります。

### <a name="profile-report-tab"></a>[プロファイル レポート] タブ

**[プロファイル レポート]** にはフィルターが 2 つあります。

- ほとんど時間が費やされていないコール ツリーのエントリをフィルターで除外するには、 **[不要項目の非表示]** フィールドに 0 から 99% のフィルター値を入力します。 既定値は 2% です。
- 自分のコードのみを対象にコール ツリーを表示するには、 **[マイ コードのみ]** チェック ボックスをオンにします。 すべてのコール ツリーを表示するには、このチェックボックスをオフにします。

**[プロファイル レポート]** タブでは、凡例にカテゴリとリンクのレポートが表示されます。 レポートを表示するには、左側でエントリを 1 つ選択します。

- **実行** **実行**レポートは、アプリケーションが実行に費やした時間の内訳を示します。

  実行時間が費やされたコード行を検索するには、コール ツリーを展開し、コール ツリー エントリのショートカット メニューで、 **[ソースの表示]** または **[呼び出しサイトの表示]** を選択します。 **[ソースの表示]** では、実行されたコード行を検索します。 **[呼び出しサイトの表示]** では、実行された行を呼び出したコード行を検索します。 呼び出しサイト行が 1 つしか存在しない場合は、そのコードが強調表示されます。 呼び出しサイトが複数存在する場合、ダイアログ ボックスで 1 つ選択し、 **[ソースに移動]** を選択します。 多くの場合、インスタンスが最も多い、または最も多くの時間を費やしている、あるいはそれら両方に当てはまる呼び出しサイト検索することが役立ちます。 詳細については、「[実行プロファイル レポート](../profiling/execution-profile-report.md)」を参照してください。

- **同期** **同期**レポートは、同期ブロックの原因となっている呼び出しと、各呼び出し履歴のブロック時間の総計を示します。 詳細については、「[同期時間](../profiling/synchronization-time.md)」を参照してください。

- **I/O** **I/O** レポートは、I/O ブロックの原因となっている呼び出しと、各呼び出し履歴のブロック時間の総計を示します。 詳細については、「[I/O 時間 (スレッド ビュー)](../profiling/i-o-time-threads-view.md)」を参照してください。

- **スリープ** **スリープ** レポートは、スリープ ブロックの原因となっている呼び出しと、各呼び出し履歴のブロック時間の総計を示します。 詳細については、「[スリープ時間](../profiling/sleep-time.md)」を参照してください。

- **メモリ管理** **メモリ管理**レポートは、メモリ管理ブロックが発生した呼び出しと、各呼び出し履歴のブロック時間の総計を示します。 この情報を使用し、過剰なページングやガベージ コレクションの問題がある領域を特定します。  詳細については、「[メモリ管理時間](../profiling/memory-management-time.md)」を参照してください。

- **優先** **優先**レポートは、システム上のプロセスが現在のプロセスよりも優先処理された箇所と、現在のプロセス内のスレッドに取って代わった個々のスレッドを示します。 この情報を使用して、優先処理の主な原因となったプロセスとスレッドを特定できます。 詳細については、「[優先時間](../profiling/preemption-time.md)」を参照してください。

- **UI 処理** **UI 処理**レポートは、UI 処理ブロックの原因となっている呼び出しと、各呼び出し履歴のブロック時間の総計を示します。 詳細については、「[UI 処理時間](../profiling/ui-processing-time.md)」を参照してください。

- **スレッド別の概要** **[スレッド別の概要]** を選択すると、現在選択されている時間間隔を対象に、スレッドの状態を示すグラフが表示されます。 色分けされた列によって、各スレッドが実行、ブロック、I/O、その他の状態にあった時間の総計が示されます。 スレッドの下部にラベルが付けられます。 タイムライン グラフでズーム レベルを調整すると、このグラフは自動的に更新されます。

  ズーム レベルによっては、一部のスレッドがグラフに表示されないことがあります。 その場合、省略記号 ( **...** ) が右側に表示されます。 必要なスレッドが表示されない場合は、他のスレッドを非表示にすることができます。 詳細については、「[スレッド別の概要レポート](../profiling/per-thread-summary-report.md)」を参照してください。

- **ディスク操作** **[ディスク操作]** を選択すると、現在のプロセスにおいてディスク I/O に関係するプロセスとスレッド、それらが接触したファイル (読み込んだ DLL など)、読み込んだバイト数などの情報が表示されます。 このレポートを使用し、実行中にファイルへのアクセスに費やされる時間を評価できます (特に、I/O バウンドなプロセスと思われる場合に役立ちます)。 詳細については、「[ディスク操作レポート](../profiling/disk-operations-report-threads-view.md)」を参照してください。

### <a name="current-tab"></a>現在のタブ
このタブでは、タイムライン グラフ内のスレッド セグメントについて、選択した時点の呼び出し履歴が表示されます。 自分のアプリに関連のあるアクティビティだけが表示されるように、呼び出し履歴は縮小表示されます。

### <a name="unblocking-stack-tab"></a>[ブロック解除スタック] タブ
このタブには、選択したスレッドのブロックを解除したスレッドとブロック解除呼び出し履歴が表示されます。

## <a name="see-also"></a>関連項目
- [コンカレンシー ビジュアライザー](../profiling/concurrency-visualizer.md)
