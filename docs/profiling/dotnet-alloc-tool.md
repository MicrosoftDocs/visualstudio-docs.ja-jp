---
title: .NET オブジェクトのメモリ使用量の分析 | Microsoft Docs
ms.date: 12/9/2019
ms.topic: how-to
helpviewer_keywords:
- memory allocation, memory usage
author: Sagar-S-S
ms.author: sashe
manager: AndSter
ms.workload:
- multiple
ms.openlocfilehash: 563531b6dfbf59e33b63dcb4561612d86cd39acc
ms.sourcegitcommit: 14637be49401f56341c93043eab560a4ff6b57f6
ms.translationtype: HT
ms.contentlocale: ja-JP
ms.lasthandoff: 09/14/2020
ms.locfileid: "90075419"
---
# <a name="analyze-memory-usage-by-using-the-net-object-allocation-tool"></a>.NET オブジェクト割り当てツールを使用してメモリ使用量を分析する

.NET オブジェクト割り当てツールを使用して、アプリで使用されているメモリの量と、最も多くのメモリを割り当てるコード パスを確認できます。

ツールを実行すると、オブジェクトが割り当てられている関数の実行パスが表示されます。 その後、最も多くのメモリを占有している呼び出しツリーのルートまでトレースすることができます。

## <a name="setup"></a>セットアップ

1. **Alt + F2** キーを押して Visual Studio でパフォーマンス プロファイラーを開きます。

1. **[.NET オブジェクト割り当て追跡]** チェック ボックスをオンにします。

   ![Dotnet オブジェクト割り当て追跡ツールを選択](../profiling/media/dotnetalloctoolselected.png "Dotnet オブジェクト割り当て追跡ツールを選択")

1. **[開始]** ボタンを選択してツールを実行します。

1. ツールの実行が開始されたら、アプリ内でプロファイリングするシナリオを検討します。 次に、**コレクションの停止**を選択するか、アプリを閉じてデータを確認します。

   ![コレクションの停止を表示しているウィンドウ](../profiling/media/stopcollectionlighttheme.png "コレクションの停止を表示しているウィンドウ")

1. **[割り当て]** タブを選択します。次のスクリーンショットのようなウィンドウ コンテンツが表示されます。

   ![[割り当て] タブ](../profiling/media/allocationview.png "[割り当て] タブ")

これで、オブジェクトのメモリ割り当てを分析できるようになりました。

コレクション中に、プロファイリングされたアプリが追跡ツールによって低速になることがあります。 追跡ツールまたはアプリのパフォーマンスが低下している場合や、すべてのオブジェクトを追跡する必要がない場合は、サンプリング レートを調整できます。 これを行うには、プロファイラーの概要ページで、追跡ツールの横にある歯車アイコンを選択します。

![Dotnet 割り当てツールの設定](../profiling/media/dotnetallocsettings.png "Dotnet 割り当てツールの設定")

サンプリング レートを希望のレートに調整します。 この変更により、コレクションと分析中にアプリのパフォーマンスを向上させることができます。

![調整されたサンプリング レート](../profiling/media/adjustedsamplingratedotnetalloctool.png "調整されたサンプリング レート")

ツールの効率を向上させる方法の詳細については、「[プロファイラー設定の最適化](../profiling/optimize-profiler-settings.md)」を参照してください。

## <a name="understand-your-data"></a>データを理解する

![Dotnet 割り当てツールのグラフ](../profiling/media/graphdotnetalloc.png "Dotnet 割り当てツールのグラフ")

上のグラフィック ビューでは、上部のグラフに、アプリ内のライブ オブジェクトの数が表示されます。 下の **[オブジェクトの差分]** グラフには、アプリ オブジェクトの変化率が表示されます。 赤色のバーは、ガベージ コレクションがいつ行われたかを表します。

![Dotnet 割り当て時間のフィルター処理されたグラフ](../profiling/media/graphdotnetalloctimefiltered.png "Dotnet 割り当て時間のフィルター処理されたグラフ")

表形式データをフィルター処理して、指定した時間範囲のアクティビティだけを表示できます。 グラフを拡大または縮小表示することもできます。

### <a name="allocation"></a>割り当て

![展開された [割り当て] ビュー](../profiling/media/allocationexpandedlight.png "展開された [割り当て] ビュー")

**[割り当て]** ビューには、メモリを割り当てているオブジェクトの場所と、それらのオブジェクトによって割り当てられているメモリの量が表示されます。

-  **[種類]**  列は、メモリを占有しているクラスと構造体の一覧です。 種類をダブルクリックし、そのバックトレースを逆呼び出しツリーとして表示します。 **[割り当て]** ビューでのみ、選択したカテゴリ内の、メモリを占有している項目を表示できます。

-  **[割り当て]**  列には、メモリを占有している、特定の割り当ての種類または関数に含まれるオブジェクトの数が表示されます。 この列が表示されるのは、 **[割り当て]** 、 **[呼び出し]** 、および  **[関数]**  ビューだけです。

- 既定では、 **[バイト]**  および  **[平均サイズ (バイト)]**  列は表示されません。 これらを表示するには、 **[種類]**  または  **[割り当て]**  列を右クリックしてから、 **[バイト]**  および  **[平均サイズ (バイト)]**  オプションを選択して、それらをグラフに追加します。 

   この 2 つの列は  **[合計 (割り当て)]** と  **[自己 (割り当て)]** に似ていますが、メモリを占有するオブジェクトの数ではなく、占有されているメモリの量が表示されています。 これらの列は **[割り当て]** ビューにのみ表示されます。

-  **[モジュール名]**  列には、呼び出している関数またはプロセスを含むモジュールが表示されます。

これらの列はすべて並べ替え可能です。  **[種類]** および **[モジュール名]** 列では、アルファベットの昇順または降順で項目を並べ替えることができます。  **[割り当て]** 、 **[バイト]**  および  **[平均サイズ (バイト)]** では、数値を増減して項目を並べ替えることができます。

#### <a name="symbols"></a>シンボル

**[割り当て]** 、 **[呼び出しツリー]** 、および **[関数]** タブには、次のシンボルが表示されます。

- ![値型シンボル](../profiling/media/valuetypeicon.png "値型シンボル") - 整数などの値の型

- ![値型コレクション シンボル](../profiling/media/valuetypecollectionicon.png "値型コレクション シンボル") - 整数の配列のような値型コレクション

- ![参照型シンボル](../profiling/media/referencetypeicon.png "参照型シンボル") - 文字列などの参照型

- ![参照型コレクション シンボル](../profiling/media/referencetypecollectionicon.png "参照型コレクション シンボル") - 文字列の配列のような参照型コレクション

### <a name="call-tree"></a>呼び出しツリー

![[呼び出しツリー] ビュー](../profiling/media/calltreelight.png "[呼び出しツリー] ビュー")

 **[呼び出しツリー]**  ビューには、大量のメモリを割り当てているオブジェクトを含む関数の実行パスが表示されます。

-  **[関数名]**  列には、メモリを割り当てるオブジェクトを含む関数のプロセスまたは名前が表示されます。 表示は、調査しているノードのレベルに基づいています。
-  **[合計 (割り当て)]** と  **[合計サイズ (バイト)]**  列には、割り当てられたオブジェクトの数と、関数およびその関数によって呼び出された他のすべての関数で使用されているメモリの量が表示されます。
- **[自己 (割り当て)]** および **[自己サイズ (バイト)]** 列には、割り当てられたオブジェクトの数と、選択された単一の関数または割り当ての種類で使用されているメモリの量が表示されます。
- **[平均サイズ (バイト)]** 列には、 **[割り当て]** ビューと同じ情報が表示されます。
-  **[モジュール名]**  列には、呼び出している関数またはプロセスを含むモジュールが表示されます。

   ![展開されたホット パス](../profiling/media/hotpathlight.png "展開されたホット パス")

- **[ホット パスの展開]** ボタンをクリックすると、メモリを割り当てているオブジェクトを数多く含む関数の実行パスが強調表示されます。 このアルゴリズムは、ユーザーが選択したノードで開始され、ほとんどの割り当てのパスを強調表示して、ユーザーの調査をガイドします。
- **[ホット パスの表示]** ボタンをクリックすると、ホット パスの一部であるノードを示す炎アイコンの表示と非表示が切り替わります。

### <a name="functions"></a>関数

![[関数] ビュー](../profiling/media/functionslight.png "[関数] ビュー")

**[関数]** ビューには、メモリを割り当てているプロセス、モジュール、および関数が表示されます。

- **[名前]** 列には、最上位レベルのノードとしてプロセスが表示されます。 プロセスの下にモジュールがあり、モジュールの下に関数があります。
- これらの列には、 **[割り当て]** および **[呼び出しツリー]** ビューと同じ情報が表示されます。

  - **合計 (割り当て)**
  - **自己 (割り当て)**
  - **合計サイズ (バイト)**
  - **自己サイズ (バイト)**
  - **平均サイズ (バイト)**

### <a name="collection"></a>コレクション

![[コレクション] ビュー](../profiling/media/collectionlight.png "[コレクション] ビュー")

**[コレクション]** ビューには、ガベージ コレクション中に収集または保持されていたオブジェクトの数が表示されます。 また、このビューには、収集されたオブジェクトと残ったオブジェクトを種類別に視覚化するためのいくつかの円グラフも表示されます。

- **[収集済み]** 列には、ガベージ コレクターによって収集されたオブジェクトの数が表示されます。
- **[残り]** 列には、ガベージ コレクターの実行後に残ったオブジェクトの数が表示されます。

### <a name="filtering-tools"></a>フィルター処理ツール

**[割り当て]** 、 **[呼び出しツリー]** 、 **[関数]** ビューのすべてに、 **[マイ コードのみ表示]** 、 **[Show Native Code]\(ネイティブ コードを表示\)** オプションとフィルター ボックスが含まれています。

- **[マイコードのみ表示]** を選択すると、システム、フレームワーク、およびその他の非ユーザーコードが **[外部コード]** フレームに折りたたまれるので、ユーザーコードに焦点を当てることができます。 詳細については、[マイ コードのみを使用したユーザー コードのデバッグ](../debugger/just-my-code.md)に関する記事を参照してください。
- **[Show Native Code]\(ネイティブ コードを表示\)** を選択すると、非ユーザー コードを含む分析ターゲット内のネイティブ コードが表示されます。
- フィルター ボックスを使用すると、指定した値に基づいて **[名前]** または **[関数名]** 列をフィルター処理できます。 ボックスに文字列値を入力してください。 テーブルに、その文字列を含む種類のみが表示されます。
