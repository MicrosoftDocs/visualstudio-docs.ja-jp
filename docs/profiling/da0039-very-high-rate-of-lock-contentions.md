---
title: DA0039 - 非常に高率のロック競合 | Microsoft Docs
description: プロファイリング データで収集されたシステム パフォーマンス データが、アプリケーションの実行中に極端に高率のロック競合が発生したことを示しています。
ms.date: 11/04/2016
ms.topic: reference
f1_keywords:
- vs.performance.39
- vs.performance.DA0039
- vs.performance.rules.DA0039
ms.assetid: 5a9fc57d-9097-413b-af0c-8726b1a57048
author: mikejo5000
ms.author: mikejo
manager: jmartens
monikerRange: vs-2017
ms.workload:
- multiple
ms.openlocfilehash: 656f9dbc3994ed47e6d7cd8077191b23aa9ead6a
ms.sourcegitcommit: 8590cf6b3351e82827fd21159beefef0c02bf162
ms.translationtype: HT
ms.contentlocale: ja-JP
ms.lasthandoff: 03/08/2021
ms.locfileid: "102465924"
---
# <a name="da0039-very-high-rate-of-lock-contentions"></a>DA0039:非常に高率のロック競合

|アイテム|[値]|
|-|-|
|規則 ID|DA0039|
|カテゴリ|.NET Framework の使用|
|プロファイル方法|サンプリング<br /><br /> インストルメンテーション<br /><br /> .NET メモリ|
|メッセージ|非常に高率の .NET ロック競合が発生しています。 コンカレンシー プロファイルを実行し、このロック競合の原因を調査してください。|
|規則の種類|警告|

 サンプリング、.NET メモリ、またはリソース競合メソッドを使用してプロファイリングを行うときは、この規則を呼び出すためのサンプルを少なくとも 25 個収集する必要があります。

## <a name="cause"></a>原因
 プロファイル データを使用して収集したシステム パフォーマンス データは、アプリケーションの実行中に極端に高率のロック競合が発生したことを示しています。 競合の原因を見つけるために、コンカレンシー プロファイルの方法を使用して、プロファイリングを再度実行することを検討してください。

## <a name="rule-description"></a>規則の説明
 ロックは、マルチスレッド アプリケーション内で、一度に 1 つのスレッドで連続的に実行する必要があるコードのクリティカル セクションを保護するために使用されます。 Microsoft .NET 共通言語ランタイム (CLR: Common Language Run-time) には、同期とロックのプリミティブの完全なセットが用意されています。 たとえば、C# 言語ではロック ステートメントがサポートされています (Visual Basic では SyncLock)。 マネージド アプリケーションは、System.Threading 名前空間内で Monitor.Enter メソッドと Monitor.Exit メソッドを呼び出すことで、ロックを直接取得および解放できます。 .NET Framework は、ミューテックス、ReaderWriter ロック、およびセマフォをサポートするクラスをはじめとする、追加の同期と競合のプリミティブをサポートします。 詳細については、MSDN Web サイトの .NET Framework 開発者ガイドの「[Overview of Synchronization Primitives](/dotnet/standard/threading/overview-of-synchronization-primitives)」 (同期プリミティブの概要) を参照してください。 .NET Framework のクラスは、それ自体が、Windows オペレーティング システムに組み込まれている下位レベルの同期サービスの上層に配置されています。 これらには、クリティカル セクション オブジェクト、および多数のさまざまな待機機能やイベント通知機能が含まれます。 詳細については、MSDN ライブラリの Win32 および COM 開発の「[Synchronization](/windows/win32/sync/synchronization)」 (同期) セクションを参照してください。

 同期と競合に使用される .NET Framework クラスとネイティブの Windows オブジェクトは両方とも、共有メモリの位置を基にしています。これは、インタロックされた操作を使用して変更する必要があります。 インタロックされた操作では、共有メモリの位置を操作するハードウェア固有の命令を使用して、アトミックな操作によってその状態を変更します。 アトミックな操作は、コンピューター内のすべてのプロセッサにわたって一貫していることが保証されています。 Locks と WaitHandles は、設定およびリセットされるときに自動的にインタロックされた操作を使用する .NET オブジェクトです。 アプリケーション内には、スレッド セーフな方法で更新するためにはインタロックされた操作も使用する必要がある、その他の共有メモリ データ構造体が存在する場合があります。 詳細については、MSDN ライブラリの .NET Framework セクションの「[インタロックされた操作](/dotnet/api/system.threading.interlocked)」を参照してください。

 同期とロックは、マルチスレッド アプリケーションが正しく実行されるようにするために使用される機構です。 マルチスレッド アプリケーションの各スレッドは、独立した実行単位であり、オペレーティング システムによって個別にスケジュールされます。 ロックの競合は、あるスレッドがロックを保持しているために、ロックを取得しようとしている別のスレッドが遅延されると発生します。

 ロックはしばしば入れ子になります。 入れ子は、クリティカル セクションを実行中のスレッドがある関数を実行し、その関数が別のロックを要求すると発生します。 ある程度のロックの入れ子は回避できません。 クリティカル セクションでは、スレッド セーフで実行されるように、ロックに依存する .NET Framework メソッドを呼び出すことがあります。 アプリケーション内のあるクリティカル セクションから Framework メソッドが呼び出され、このメソッドも異なるロック ハンドルを使用してロックを要求する場合、ロックは入れ子になります。 入れ子になったロック状態は、解消および修復が困難とされているパフォーマンス上の問題につながる可能性があります。

 この規則は、プロファイリング実行中に取得された測定値により、ロック競合量が過度に多いことが示された場合に適用されます。 ロックの競合により、ロックを待機しているスレッドの実行が遅延します。 最低限のハードウェアで実行される単体テストまたはロード テストでの少量のロックの競合であっても、調査する必要があります。

> [!NOTE]
> プロファイル データ中の、報告されたロックの競合の比率が高いが過度ではない場合、この警告メッセージではなく "[DA0038:高率のロック競合](../profiling/da0038-high-rate-of-lock-contentions.md)" の情報メッセージが表示されます。

## <a name="how-to-investigate-a-warning"></a>警告の調査方法
 メッセージをダブルクリックして、プロファイル データの [[マーク]](../profiling/marks-view.md) ビューに移動します。  **.NET CLR LocksAndThreads\Contention Rate / sec** 列を探します。 ロックの競合が他のフェーズよりも多い特定のプログラム実行フェーズがあるかどうかを確認します。

 この規則は、コンカレンシー プロファイル方法を使用していない場合にのみ適用されます。 コンカレンシー プロファイル方法は、アプリケーション内でのロックの競合に関連するパフォーマンス上の問題を診断するのに最適なツールです。 コンカレンシー プロファイル データを収集して、アプリケーションのロック動作を確認してください。 これには、競合の多いロックはどれであるか、実行時間の長いスレッドは競合したロックを待機してどのように遅延するか、および示唆される特定のコードはどれであるかの確認が含まれます。 コンカレンシー プロファイルは、すべてのロック競合についてデータを収集します。これには、ネイティブの Windows 機能、.NET Framework クラス、およびアプリケーションで参照するその他すべてのサードパーティ ライブラリが含まれます。 [!INCLUDE[vsprvs](../code-quality/includes/vsprvs_md.md)] IDE からのコンカレンシー プロファイルの情報については、「[スレッドおよびプロセスのコンカレンシー データの収集](../profiling/collecting-thread-and-process-concurrency-data.md)」を参照してください。 コマンド ラインからのコンカレンシー プロファイルの情報へのリンクについては、「[コマンド ラインからのプロファイル方法の使用](../profiling/using-profiling-methods-to-collect-performance-data-from-the-command-line.md)」の「**コンカレンシー メソッドを使用してリソースの競合およびスレッド アクティビティのデータを収集する**」セクションを参照してください。
