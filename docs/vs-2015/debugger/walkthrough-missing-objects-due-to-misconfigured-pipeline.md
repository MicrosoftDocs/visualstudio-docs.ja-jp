---
title: 'チュートリアル: シェーディングによるオブジェクトの不足 |Microsoft Docs'
ms.date: 11/15/2016
ms.prod: visual-studio-dev14
ms.technology: vs-ide-debug
ms.topic: conceptual
ms.assetid: ed8ac02d-b38f-4055-82fb-67757c2ccbb9
caps.latest.revision: 16
author: MikeJo5000
ms.author: mikejo
manager: jillfra
ms.openlocfilehash: 800fa29682460991ca28a0dacb6d5b5a4a9838d4
ms.sourcegitcommit: c496a77add807ba4a29ee6a424b44a5de89025ea
ms.translationtype: MT
ms.contentlocale: ja-JP
ms.lasthandoff: 01/24/2019
ms.locfileid: "58963811"
---
# <a name="walkthrough-missing-objects-due-to-misconfigured-pipeline"></a>チュートリアル: パイプラインの構成が不適切なことによるオブジェクトの不足
[!INCLUDE[vs2017banner](../includes/vs2017banner.md)]

このチュートリアルでは、ピクセル シェーダーが設定されていないことが原因で表示されないオブジェクトを調査するために、 [!INCLUDE[vsprvs](../includes/vsprvs-md.md)] のグラフィックス診断ツールを使用する方法を示します。  
  
 このチュートリアルでは、次の作業について説明します。  
  
-   **[グラフィックス イベント一覧]** を使用して、問題の原因となる可能性がある部分を検索します。  
  
-   **[グラフィックス イベント一覧]** ウィンドウを使用して、 `DrawIndexed` Direct3D API 呼び出しの影響を調べます。  
  
-   シェーダー ステージが設定されていないかどうかを確認するためにデバイス コンテキストをチェックします。  
  
-   **[グラフィックス パイプライン ステージ]** ウィンドウを **[グラフィックス イベント呼び出し履歴]** と一緒に使って、ピクセル シェーダーが設定されていない原因を見つけます。  
  
## <a name="scenario"></a>シナリオ  
 3D アプリでオブジェクトが表示されない場合、そのオブジェクトがレンダリングされる前にシェーダー ステージの 1 つが設定されないことが原因となることがあります。 レンダリングのニーズがシンプルなアプリでは、このエラーの原因が、オブジェクトの描画呼び出しの呼び出し履歴の中に見つかることがよくあります。 ただし、最適化の手法として、アプリによっては、シェーダー プログラム、テクスチャ、その他のデータに共通しているオブジェクトをまとめてバッチ処理することにより、状態変化のオーバーヘッドを軽減する場合があります。 このようなアプリでは、エラーの原因が、描画呼び出しの呼び出し履歴ではなく、バッチ処理システムに埋もれている可能性があります。 このチュートリアルのシナリオでは、レンダリングのニーズがシンプルなアプリを例にとって、エラーの原因が呼び出し履歴の中に見つかるケースをご紹介します。  
  
 このシナリオでは、テストのためにアプリケーションを実行すると、背景は期待どおりにレンダリングされますが、オブジェクトの 1 つが表示されません。 グラフィックス診断を使うと、問題点をグラフィックス ログにキャプチャし、アプリのデバッグを実行できます。 問題は、アプリケーションでは次のように見えます。  
  
 ![オブジェクトを表示できません](../debugger/media/gfx-diag-demo-misconfigured-pipeline-problem.png "gfx_diag_demo_misconfigured_pipeline_problem")  
  
## <a name="investigation"></a>調査  
 グラフィックス診断ツールを使うと、グラフィックス ログのドキュメントを読み込んで、テスト中にキャプチャされたフレームを調査できます。  
  
#### <a name="to-examine-a-frame-in-a-graphics-log"></a>グラフィックス ログのフレームを調査するには  
  
1. [!INCLUDE[vsprvs](../includes/vsprvs-md.md)]で、オブジェクトが表示されない現象を示しているフレームを含んだグラフィックス ログのドキュメントを読み込みます。 新しいグラフィックス ログのタブが [!INCLUDE[vsprvs](../includes/vsprvs-md.md)]に表示されます。 このタブの上部に、選択されたフレームのレンダー ターゲットが出力されます。 下部の **[フレーム一覧]** には、キャプチャされた各フレームの縮小版が表示されます。  
  
2. **[フレーム一覧]** で、オブジェクトが表示されないことを示すフレームを選択します。 レンダー ターゲットが更新され、選択したフレームが反映されます。 このシナリオでは、グラフィックス ログのタブは次のように表示されます。  
  
    ![Visual Studio のグラフィックス ログ ドキュメント](../debugger/media/gfx-diag-demo-misconfigured-pipeline-step-1.png "gfx_diag_demo_misconfigured_pipeline_step_1")  
  
   問題を示しているフレームを選択したら、 **[グラフィックス イベント一覧]** を使ってそのフレームの診断を始めます。 **[グラフィックス イベント一覧]** には、アクティブなフレームをレンダリングするために実行されたすべての Direct3D API 呼び出しが含まれています。たとえば、デバイスの状態の設定、バッファーの作成と更新、フレームに表示するオブジェクトの描画などを行う呼び出しです。 Draw、Dispatch、Copy、Clear など、数多くの種類の呼び出しが関係しています。アプリが想定どおりに動作しているときは、それらの各呼び出しに対応する変化がレンダー ターゲットに表れることが多い (いつもとは限りません) からです。 Draw 呼び出しは、それぞれがアプリによってレンダリングされるジオメトリを表しているため、特に関心を向ける必要があります。  
  
   レンダー ターゲットには、問題のオブジェクトが表示されないだけでなく、その他のエラーも表示されないため、 **[グラフィックス イベント一覧]** を **[グラフィックス パイプライン ステージ]** ツールと一緒に使って、表示されないオブジェクトのジオメトリにどの描画呼び出しが対応しているかを調べます。 **[グラフィックス パイプライン ステージ]** ウィンドウには、レンダー ターゲットに対する影響とは無関係に、各描画呼び出しに送られたジオメトリが表示されます。 描画呼び出し間を移動すると、パイプライン ステージは各呼び出しに関連するジオメトリを表示するように更新され、ジオメトリは有効な各ステージ間を流れていきます。また、レンダー ターゲットの出力は、その呼び出しが完了した後のレンダー ターゲットの状態を示すように更新されます。  
  
#### <a name="to-find-the-draw-call-for-the-missing-geometry"></a>表示されないジオメトリに対応する描画呼び出しを見つけるには  
  
1. **[グラフィックス イベント一覧]** ウィンドウを開きます。 **[グラフィックス診断]** ツール バーで、 **[イベント一覧]** を選択します。  
  
2. **[グラフィックス パイプライン ステージ]** ウィンドウを開きます。 **[グラフィックス診断]** ツール バーで、 **[パイプライン ステージ]** を選択します。  
  
3. **[グラフィックス イベント一覧]** ウィンドウで各描画呼び出し間を移動しながら、 **[グラフィックス パイプライン ステージ]** ウィンドウで、表示されないオブジェクトを探します。 この操作を簡単に行うには、 **[グラフィックス イベント一覧]** ウィンドウの右上隅にある **[検索]** ボックスに「Draw」と入力します。 これによって一覧がフィルター処理され、タイトルに "Draw" を含むイベントのみが一覧に表示されます。  
  
    **[グラフィックス パイプライン ステージ]** ウィンドウで、 **[入力アセンブラー]** ステージは変換される前のオブジェクトのジオメトリを示し、 **[頂点シェーダー]** ステージは変換された後の同じオブジェクトを示します。 このシナリオでは、 **[グラフィックス パイプライン ステージ]** ウィンドウを見ると、描画呼び出しの 1 つについて **[入力アセンブラー]** ステージと  **[頂点シェーダー]** ステージが表示されますが、 **[ピクセル シェーダー]** ステージは表示されないことに注目してください。  
  
   > [!NOTE]
   >  問題のオブジェクトの処理に他のパイプライン ステージ (ハル シェーダー、ドメイン シェーダー、ジオメトリ シェーダーの各ステージなど) が関係している場合は、そのいずれかが問題の原因である可能性もあります。 多くの場合、結果が表示されない、または予期しない表示になる最も早いステージが、問題に関連しています。  
  
4. 表示されないオブジェクトに対応する描画呼び出しに到達したら、停止します。 このシナリオで、 **[グラフィックス パイプライン ステージ]** ウィンドウは、ジオメトリが GPU に発行されたこと ( **[入力アセンブラー]** ステージが存在することによって示される)、そして変換されたこと ( **[頂点シェーダー]** ステージが存在することによって示される) を示していますが、アクティブなピクセル シェーダーが原因でオブジェクトがレンダー ターゲットに表示されないと考えられること ( **[ピクセル シェーダー]** ステージが存在しないことによって示される) も示しています。 このシナリオでは、さらに、表示されないオブジェクトのシルエットが **[出力マージャー]** ステージに表れています。  
  
    ![DrawIndexed イベントと、パイプラインに与える影響](../debugger/media/gfx-diag-demo-misconfigured-pipeline-step-2.png "gfx_diag_demo_misconfigured_pipeline_step_2")  
  
   こうして、表示されないオブジェクトのジオメトリについてアプリが描画呼び出しを発行したことを確認し、ピクセル シェーダーのステージがアクティブでないことを検出できたので、次に、この発見を確認するためにデバイスの状態を調査することができます。 デバイス コンテキストやその他の Direct3D オブジェクト データを調べるには、 **[グラフィックス オブジェクト テーブル]** を利用できます。  
  
#### <a name="to-examine-device-context"></a>デバイス コンテキストを確認するには  
  
1. **[d3d11 デバイス コンテキスト]** を開きます。 **[グラフィックス パイプライン ステージ]** ウィンドウで、ウィンドウの上部に表示されている **呼び出しの一部である** ID3D11DeviceContext `DrawIndexed` リンクを選択します。  
  
2. **[d3d11 デバイス コンテキスト]** タブに表示されているデバイス状態を調べて、描画呼び出し中にアクティブなピクセル シェーダーがなかったことを確認します。 このシナリオでは、 **[ピクセル シェーダーの状態]** の下に表示される **[シェーダーの一般情報]** に、そのシェーダーが **NULL**であることが示されます。  
  
    ![D3d11 デバイス コンテキストは、ピクセル シェーダーの状態を示しています](../debugger/media/gfx-diag-demo-misconfigured-pipeline-step-4.png "gfx_diag_demo_misconfigured_pipeline_step_4。")  
  
   ピクセル シェーダーがアプリによって null に設定されていることを確認した後は、次の手順として、アプリのソース コードでシェーダーが設定されている場所を探します。 **[グラフィックス イベント一覧]** を **[グラフィックス イベント呼び出し履歴]** と一緒に使うと、その場所を見つけることができます。  
  
#### <a name="to-find-where-the-pixel-shader-is-set-in-your-apps-source-code"></a>アプリケーションのソース コード内でピクセル シェーダーが設定されている場所を見つけるには  
  
1. 表示されないオブジェクトに対応する `PSSetShader` 呼び出しを見つけます。 **[グラフィックス イベント一覧]** ウィンドウで、 **[グラフィックス イベント一覧]** ウィンドウの右上隅にある **[検索]** ボックスに「Draw;PSSetShader」と入力します。 これによって一覧がフィルター処理され、"PSSetShader" イベントのうちタイトルに "Draw" を含むイベントのみが一覧に表示されます。 表示されないオブジェクトの描画呼び出しより前にある最初の `PSSetShader` 呼び出しを選びます。  
  
   > [!NOTE]
   >  `PSSetShader` は、このフレームの間に設定されなかった場合は、 **[グラフィックス イベント一覧]** ウィンドウには表示されません。 通常、これが発生するのは、すべてのオブジェクトに対してピクセル シェーダーを 1 つだけ使う場合か、 `PSSetShader` 呼び出しがこのフレームの間に誤ってスキップされた場合のみです。 どちらの場合も、 `PSSetShader` 呼び出しをアプリのソース コードを検索すること、また、これらの呼び出しの動作を確認するために従来のデバッグ手法を使うことをお勧めします。  
  
2. **[グラフィックス イベント呼び出し履歴]** ウィンドウを開きます。 **[グラフィックス診断]** ツール バーで、 **[グラフィックス イベント呼び出し履歴]** を選びます。  
  
3. この呼び出し履歴を使って、アプリのソース コードから `PSSetShader` 呼び出しを見つけます。 **[グラフィックス イベント呼び出し履歴]** ウィンドウで、最上位の呼び出しを選択し、ピクセル シェーダーに設定される値を確認します。 ピクセル シェーダーは、直接 null に設定されるケースと、関数に渡された引数またはその他の状態が原因で null 値が発生するケースがあります。 直接設定されてはいない場合は、呼び出し履歴を上にさかのぼると、null 値の原因が見つかることがあります。 このシナリオでは、一番上の `nullptr` nullptr `CubeRenderer::Render`であることが示されます。  
  
    ![ピクセル シェーダーを初期化しないコード](../debugger/media/gfx-diag-demo-misconfigured-pipeline-step-5.png "gfx_diag_demo_misconfigured_pipeline_step_5")  
  
   > [!NOTE]
   >  呼び出し履歴を調べても null 値の原因が見つからない場合は、 `PSSetShader` 呼び出しに条件付きのブレークポイントを設定し、ピクセル シェーダーに null が設定された時点でプログラムにブレークが入るようにすることをお勧めします。 その後、デバッグ モードでアプリを再開し、従来のデバッグ手法を使って null 値の原因を突き止めます。  
  
   問題を修正するには、 `ID3D11DeviceContext::PSSetShader` API 呼び出しの最初のパラメーターを使って正しいピクセル シェーダーを割り当てます。  
  
   ![修正された C&#43; &#43;ソース コード](../debugger/media/gfx-diag-demo-misconfigured-pipeline-step-6.png "gfx_diag_demo_misconfigured_pipeline_step_6")  
  
   コードを修正したら、アプリをリビルドし、アプリをもう一度実行してレンダリングの問題が解決されたことを確認します。  
  
   ![オブジェクトが表示されるようになりました](../debugger/media/gfx-diag-demo-misconfigured-pipeline-resolution.jpg "gfx_diag_demo_misconfigured_pipeline_resolution")
