---
title: Azure Cloud Services および virtual machines の診断の設定 |Microsoft Docs
description: Azure クラウド サービスと Visual Studio での仮想マシン (Vm) をデバッグするための診断を設定する方法について説明します。
author: mikejo5000
manager: douge
ms.assetid: e70cd7b4-6298-43aa-adea-6fd618414c26
ms.topic: conceptual
ms.workload: azure-vs
ms.date: 06/28/2018
ms.author: mikejo
ms.prod: visual-studio-dev14
ms.technology: vs-azure
ms.openlocfilehash: 4448825c5d443887833a405aab14d2243a0e5216
ms.sourcegitcommit: e481d0055c0724d20003509000fd5f72fe9d1340
ms.translationtype: MT
ms.contentlocale: ja-JP
ms.lasthandoff: 11/05/2018
ms.locfileid: "51003072"
---
# <a name="set-up-diagnostics-for-azure-cloud-services-and-virtual-machines"></a>Azure クラウド サービスと仮想マシンに対する診断を設定する
Azure クラウド サービスまたは仮想マシンのトラブルシューティングを行う必要がある場合は Visual Studio を使用してより簡単に Azure 診断を設定することができます。 診断は、システム データと仮想マシンおよびクラウド サービスを実行する仮想マシン インスタンスでログ データをキャプチャします。 診断データは、選択したストレージ アカウントに転送されます。 診断の詳細については、Azure でのログを参照してください[Azure App Service で Web アプリに対して診断ログを有効にする](/azure/app-service/web-sites-enable-diagnostic-log)します。

この記事で紹介する Visual Studio を使用して有効にして前に、と配置後に、Azure 診断を設定する方法。 Azure virtual machines で診断を設定する方法や、収集する診断情報の種類を選択する方法、収集した情報を表示する方法について説明します。

Azure 診断を設定するには、次のオプションのいずれかを使用できます。

* 診断設定を変更、**診断構成**Visual Studio でのダイアログ ボックス。 設定は、diagnostics.wadcfgx (Azure SDK 2.4 以降では、ファイルは diagnostics.wadcfg という名前) という名前のファイルに保存されます。 構成ファイルを直接変更することもできます。 ファイルを手動で更新する場合、構成の変更が適用次に、クラウドをデプロイするときはサービスを Azure にまたはエミュレーターでサービスを実行します。
* Visual Studio で Cloud Explorer またはサーバー エクスプ ローラーを使用して、クラウド サービスまたはが実行されている仮想マシンの診断設定を変更します。

## <a name="azure-sdk-26-diagnostics-changes"></a>Azure SDK 2.6 の診断の変更
次の変更は、Azure SDK 2.6 と Visual Studio での以降のプロジェクトに適用されます。

* ローカル エミュレーターでは、診断できるようになりました。 これは、診断データを収集および開発および Visual Studio でテストするときに、アプリケーションが正しくトレースを作成することを確認できることを意味します。 接続文字列`UseDevelopmentStorage=true`Azure ストレージ エミュレーターを使用して Visual Studio でクラウド サービス プロジェクトを実行する際に、診断データの収集をオンにします。 すべての診断データは、開発ストレージのストレージ アカウントに収集されます。
* 診断ストレージ アカウント接続文字列`Microsoft.WindowsAzure.Plugins.Diagnostics.ConnectionString`サービス構成 (.cscfg) ファイルに格納されます。 Azure SDK 2.5 では、診断ストレージ アカウントは diagnostics.wadcfgx ファイルで指定されます。

接続文字列は、いくつか主要な方法で Azure SDK 2.6 以降と Azure SDK 2.4 および前に異なる方法では動作します。

* Azure SDK 2.4 以降では、接続文字列として使用されますランタイム診断プラグインが診断ログを転送するためのストレージ アカウント情報を取得します。
* Azure SDK 2.6 以降では、Visual Studio は、診断接続文字列を使用して、発行時に適切なストレージ アカウント情報で Azure 診断拡張機能を設定します。 接続文字列を使用すると、別のストレージ アカウントの発行時に Visual Studio を使用する別のサービス構成を定義します。 ただし、Azure SDK 2.5 以降後、診断プラグインを利用できないために、.cscfg ファイルだけでは、診断拡張機能を設定できません。 Visual Studio や PowerShell などのツールを使用して、拡張機能を個別に設定する必要があります。
* PowerShell を使用して診断拡張機能の設定のプロセスを簡略化するのには、Visual Studio からの出力パッケージにはには、ロールごとに診断拡張機能のパブリック構成 XML が含まれています。 Visual Studio では、パブリック構成のストレージ アカウント情報の設定に、診断接続文字列を使用します。 パブリック構成ファイルは、拡張機能フォルダーに作成されます。 パブリック構成ファイルでは、PaaSDiagnostics の名前付けパターンを使用します。&lt;ロール名\>します。PubConfig.xml します。 任意の PowerShell ベースの展開では、各構成をロールにマップするのにこのパターンを使用できます。
* [Azure portal](http://go.microsoft.com/fwlink/p/?LinkID=525040) .cscfg ファイルで診断データにアクセスする接続文字列を使用します。 データが表示されます、**監視**タブ。ポータルで詳細監視データを表示するサービスを設定する接続文字列が必要です。

## <a name="migrate-projects-to-azure-sdk-26-and-later"></a>Azure SDK 2.6 以降のプロジェクトを移行します。
.Wadcfgx ファイルで指定された診断ストレージ アカウントがある場合に、Azure SDK 2.6 以降の Azure SDK 2.5 から移行する場合、ストレージ アカウントは、そのファイルにとどまります。 さまざまなストレージ構成の別のストレージ アカウントを使用する柔軟性を利用するには、プロジェクトに接続文字列を手動で追加します。 Azure SDK 2.4 以前から、または以前のバージョンから Azure SDK 2.6 にプロジェクトを移行する、診断接続文字列が維持されます。 ただし、前のセクションで説明されている、Azure SDK 2.6 での接続文字列を処理する方法の変更に注意してください。

### <a name="how-visual-studio-determines-the-diagnostics-storage-account"></a>Visual Studio が診断ストレージ アカウントを決定する方法
* 診断接続文字列が .cscfg ファイルで指定された、発行時と、パッケージ処理中に、パブリック構成 XML ファイルを生成するときに、診断拡張機能を設定する Visual Studio 使用します。
* 診断接続文字列が .cscfg ファイルで指定されていない場合は、Visual Studio にフォールバックの発行、およびパブリック構成 XML を生成するために診断拡張機能を設定する、.wadcfgx ファイルで指定されているストレージ アカウントを使用してパッケージ化中にファイル。
* .Cscfg ファイル内の診断接続文字列は、.wadcfgx ファイルでストレージ アカウントよりも優先されます。 診断接続文字列の場合、.cscfg ファイルで指定された Visual Studio はその接続文字列を使用、.wadcfgx のストレージ アカウントは無視されます。

### <a name="what-does-the-update-development-storage-connection-strings-check-box-do"></a>「開発ストレージ接続文字列 の更新」チェック ボックスは何をしますか。
**Microsoft Azure に発行するときは、Microsoft Azure ストレージ アカウントの資格情報で診断とキャッシュ用開発ストレージ接続文字列を更新** チェック ボックスは任意の開発ストレージを更新する便利な方法アカウントの接続文字列の発行時に指定した Azure storage アカウントを使用します。

このチェック ボックスと、診断接続文字列を選択した場合の指定など`UseDevelopmentStorage=true`を Azure にプロジェクトをパブリッシュするときに、Visual Studio で指定したストレージ アカウントを使用して、診断接続文字列を自動的に更新発行ウィザード。 ただし、実際のストレージ アカウントは、診断接続文字列として指定されている場合、そのアカウント代わりに使用されます。

## <a name="diagnostics-functionality-differences-in-azure-sdk-24-and-earlier-vs-azure-sdk-25-and-later"></a>Azure SDK 2.4 およびそれ以前の vs での診断機能の違いAzure SDK 2.5 以降
Azure SDK 2.4 以前から、以前のバージョンから Azure SDK 2.5 またはそれ以降は、プロジェクトをアップグレードする場合は、次の診断機能の違いに注意してください。

* **構成 Api は非推奨と**します。 プログラムによる診断の構成では、利用可能で、Azure SDK 2.4 以前のバージョンですが、Azure SDK 2.5 以降では非推奨とされます。 診断の構成は、コードで現在定義は、作業を続ける診断、移行したプロジェクトでゼロからこれらの設定を再構成する必要があります。 Azure SDK 2.4 の診断構成ファイルは、diagnostics.wadcfg です。 Azure SDK 2.5 以降の診断構成ファイルには diagnostics.wadcfgx です。
* **クラウド サービス アプリケーションの診断はロール レベルでのみ構成できます**します。 Azure SDK 2.5 以降は、インスタンス レベルでクラウド サービス アプリケーションの診断を設定することはできません。
* **診断構成が更新されるたびに、アプリを展開する**します。 これは Visual Studio サーバー エクスプ ローラーから、診断構成を変更し、アプリを再デプロイする場合、パリティの問題が発生することができます。
* **診断構成ファイルで、コードではなく、クラッシュ ダンプが構成された Azure SDK 2.5 以降では、** します。 クラッシュ ダンプをコードで構成した場合は、構成ファイルに、コードから構成を手動で転送する必要があります。 クラッシュ ダンプは、Azure SDK 2.6 への移行中に移行されません。

## <a name="turn-on-diagnostics-in-cloud-service-projects-before-you-deploy-them"></a>これらを展開する前に、クラウド サービス プロジェクトで診断をオンします。
Visual Studio では、展開する前にエミュレーターでサービスを実行するときに、Azure で実行されるロールの診断データを収集できます。 Visual Studio での診断設定をすべての変更は、diagnostics.wadcfgx 構成ファイルに保存されます。 これらの設定は、クラウド サービスをデプロイするときに診断データが保存されているストレージ アカウントを指定します。

[!INCLUDE [cloud-services-wad-warning](./includes/cloud-services-wad-warning.md)]

### <a name="to-turn-on-diagnostics-in-visual-studio-before-deployment"></a>デプロイ前に Visual Studio で診断を有効にするには

1. ロールのショートカット メニューを選択**プロパティ**します。 ロールの**プロパティ**ダイアログ ボックスで、**構成** タブ。
2. **診断**セクションで、ことを確認、**診断の有効化** チェック ボックスをオンします。
   
    ![診断の有効化 オプションにアクセスします。](./media/vs-azure-tools-diagnostics-for-cloud-services-and-virtual-machines/IC796660.png)
3. 診断データのストレージ アカウントを指定するには、省略記号 (...) ボタンを選択します。
   
    ![使用するストレージ アカウントを指定します。](./media/vs-azure-tools-diagnostics-for-cloud-services-and-virtual-machines/IC796661.png)
4. **ストレージ接続文字列の作成** ダイアログ ボックスで、Azure ストレージ エミュレーター、Azure サブスクリプションを使用して接続する場合や、手動で入力された資格情報かどうかを指定します。
   
    ![ストレージ アカウント ダイアログ ボックス](./media/vs-azure-tools-diagnostics-for-cloud-services-and-virtual-machines/IC796662.png)
   
   * 選択した場合**Microsoft Azure ストレージ エミュレーター**、接続文字列に設定されて`UseDevelopmentStorage=true`します。
   * 選択した場合**サブスクリプション**を使用する Azure サブスクリプションを選択してアカウント名を入力します。 Azure サブスクリプションを管理するには、次のように選択します。 **Manage Accounts**します。
   * 選択した場合**資格情報を手動で入力された**、使用する Azure アカウントのキーと名前を入力します。
5. 表示する、**診断構成**ダイアログ ボックスで、**構成**します。 除く**全般**と**ログ ディレクトリ**、各タブは、収集できる診断データ ソースを表します。 既定の**全般** タブには、次の診断データの収集オプション:**エラーのみ**、**すべての情報**、および**カスタム プラン**. 既定の**エラーのみ**オプションは警告またはトレース メッセージを転送しないため、最小限のストレージを使用します。 **情報をすべて**オプションが、最も多くの情報を転送し、最大限のストレージを使用およびが最も高いオプションは、そのため、します。

   > [!NOTE]
   > "MB のディスク クォータ"サポートされる最小サイズは、4 GB です。 ただし、メモリ ダンプを収集している場合を 10 GB のように高い値を大ききます。
   >
  
    ![Azure 診断と構成を有効にします。](./media/vs-azure-tools-diagnostics-for-cloud-services-and-virtual-machines/IC758144.png)
6. この例では、選択、**カスタム プラン**オプション、ため、収集したデータをカスタマイズすることができます。
7. **ディスク クォータ (mb)** ボックスで、診断データのストレージ アカウントに割り当てる領域の量を設定することができます。 変更または既定値をそのまま使用できます。
8. 収集する診断データの各タブの**の転送を有効にする\<ログの種類\>** チェック ボックスをオンします。 アプリケーションのログを収集する場合など、**アプリケーション ログ**] タブで、[、**アプリケーション ログの転送を有効にする**チェック ボックスをオンします。 また、診断データの種類ごとに必要なその他の情報を指定します。 各タブの構成については、セクションをご覧ください。**診断データのソース**この記事で後述します。 
9. 必要なすべての診断データの収集を有効にした後、選択**OK**します。
10. Visual Studio での Azure クラウド サービス プロジェクトを通常どおり実行します。 アプリケーションを使用すると、有効にしたログ情報は、指定した Azure ストレージ アカウントに保存されます。

## <a name="turn-on-diagnostics-on-azure-virtual-machines"></a>Azure の仮想マシンの診断を有効にします。
Visual Studio では、Azure の仮想マシンの診断データを収集できます。

### <a name="to-turn-on-diagnostics-on-azure-virtual-machines"></a>Azure virtual machines で診断を有効にするには

1. サーバー エクスプ ローラーで、[Azure] ノードを選択し、接続していない場合、Azure サブスクリプションに接続します。
2. 展開、**仮想マシン**ノード。 新しい仮想マシンを作成したり、既存のノードを選択することができます。
3. 仮想マシンのショートカット メニューを選択**構成**します。 仮想マシンの構成 ダイアログ ボックスが表示されます。
   
    ![Azure の仮想マシンを構成します。](./media/vs-azure-tools-diagnostics-for-cloud-services-and-virtual-machines/IC796663.png)
4. インストールされていない場合は、Microsoft Monitoring Agent 診断拡張機能を追加します。 、この拡張機能では、Azure の仮想マシンに関する診断データを収集できます。 **拡張機能のインストールされている**で、**使用可能な拡張機能の選択**ドロップダウン リスト ボックスで、選択**Microsoft Monitoring Agent 診断**。
   
    ![Azure 仮想マシン拡張機能をインストールします。](./media/vs-azure-tools-diagnostics-for-cloud-services-and-virtual-machines/IC766024.png)
   
    > [!NOTE]
   > その他の診断拡張機能仮想マシンに利用できます。 詳細については、次を参照してください。[仮想マシン拡張機能と Windows の機能](https://docs.microsoft.com/azure/virtual-machines/windows/extensions-features)します。
   > 
   > 
5. 拡張機能とビューを追加するその**診断構成**ダイアログ ボックスで、**追加**します。
6. ストレージ アカウントを指定するには、次のように選択します。**構成**、し、 **OK**します。
   
    各タブ (を除く**全般**と**ログ ディレクトリ**) に収集できる診断データ ソースを表します。
   
    ![Azure 診断と構成を有効にします。](./media/vs-azure-tools-diagnostics-for-cloud-services-and-virtual-machines/IC758144.png)
   
    既定のタブ**全般**、次の診断データの収集オプションを提供しています:**エラーのみ**、**すべての情報**、および**カスタム プラン**. 既定のオプションで**エラーのみ**、警告またはトレース メッセージを転送しないために、ストレージ量が少なくがかかります。 **情報をすべて**オプションは、ほとんどの情報を転送しが、そのため、ストレージ コストが最も高いオプションです。
7. この例では、選択、**カスタム プラン**オプションは、データをカスタマイズするために収集します。
8. **ディスク クォータ (mb)** ボックスするを割り当て、ストレージ アカウントで診断データの領域の量を指定します。 する場合は、既定値を変更できます。
9. 収集する診断データの各タブで次のように選択します。 その**の転送を有効にする\<ログの種類\>** チェック ボックスをオンします。
   
    たとえば、アプリケーション ログを収集する場合は、選択、**アプリケーション ログの転送を有効にする**チェック ボックスをオン、**アプリケーション ログ**タブ。また、診断データの種類ごとに必要なその他の情報を指定します。 各タブの構成については、セクションをご覧ください。**診断データのソース**この記事で後述します。
10. 必要なすべての診断データの収集を有効にした後、選択**OK**します。
11. 更新されたプロジェクトを保存します。
    
    内のメッセージ、 **Microsoft Azure のアクティビティ ログ**ウィンドウは、仮想マシンが更新されたことを示します。

## <a name="set-up-diagnostics-data-sources"></a>診断データ ソースを設定します。
診断データの収集を有効にした後、収集するデータ ソースは正確に何と収集される情報を選択できます。 次のセクションでは、説明内のタブ、**診断の構成** ダイアログ ボックスと各構成オプションはどのようなことを意味します。

### <a name="application-logs"></a>アプリケーション ログ
アプリケーション ログには、web アプリケーションによって生成される診断情報があります。 アプリケーション ログをキャプチャする場合は、選択、**アプリケーション ログの転送を有効にする**チェック ボックスをオンします。 ストレージ アカウントへのアプリケーション ログの転送間隔を増減するには、変更、**転送間隔 (分)** 値。 変更することも設定して、ログに取り込む情報の量、**ログ レベル**値。 たとえば、選択**Verbose**取得の詳細については、または選択**重大**重大なエラーのみをキャプチャします。 プロバイダーの GUID を追加することで、ログをキャプチャするにはアプリケーション ログを出力する特定の診断プロバイダーがあれば、**プロバイダー GUID**ボックス。

  ![アプリケーション ログ](./media/vs-azure-tools-diagnostics-for-cloud-services-and-virtual-machines/IC758145.png)

アプリケーション ログの詳細については、次を参照してください。 [Azure App Service で Web アプリに対して診断ログを有効にする](/azure/app-service/web-sites-enable-diagnostic-log)します。

### <a name="windows-event-logs"></a>Windows イベント ログ
Windows イベント ログをキャプチャするには、選択、 **Windows イベント ログの転送を有効にする**チェック ボックスをオンします。 ストレージ アカウントへのイベント ログの転送間隔を増減するには、変更、**転送間隔 (分)** 値。 追跡するイベントの種類のチェック ボックスを選択します。

![イベント ログ](./media/vs-azure-tools-diagnostics-for-cloud-services-and-virtual-machines/IC796664.png)

Azure SDK 2.6 以降を使用している場合に、カスタム データ ソースを指定するを入力します。、 **\<データ ソース名\>** クリックしてテキスト ボックスに、**追加**します。 データ ソースが diagnostics.cfcfg ファイルに追加されます。

Azure SDK 2.5 を使用しているカスタム データ ソースを指定する場合に追加できる、 `WindowsEventLog` diagnostics.wadcfgx のファイル、ような次の例。

```
<WindowsEventLog scheduledTransferPeriod="PT1M">
   <DataSource name="Application!*" />
   <DataSource name="CustomDataSource!*" />
</WindowsEventLog>
```
### <a name="performance-counters"></a>パフォーマンス カウンター
パフォーマンス カウンターの情報は、システムのボトルネックを見つけて、システムとアプリケーションのパフォーマンスを微調整するのに役立ちます。 詳細については、次を参照してください。 [Azure アプリケーションでパフォーマンス カウンターの作成と使用](https://msdn.microsoft.com/library/azure/hh411542.aspx)します。 パフォーマンス カウンターをキャプチャするには、選択、**パフォーマンス カウンターの転送を有効にする**チェック ボックスをオンします。 ストレージ アカウントへのイベント ログの転送間隔を増減するには、変更、**転送間隔 (分)** 値。 追跡するパフォーマンス カウンターのチェック ボックスを選択します。

![パフォーマンス カウンター](./media/vs-azure-tools-diagnostics-for-cloud-services-and-virtual-machines/IC758147.png)

一覧にないパフォーマンス カウンターを追跡するには、推奨の構文を使用して、パフォーマンス カウンターを入力します。 選び**追加**します。 仮想マシンのオペレーティング システムでは、パフォーマンス カウンターを追跡することを決定します。構文の詳細については、次を参照してください。[カウンター パスを指定して](https://msdn.microsoft.com/library/windows/desktop/aa373193.aspx)します。

### <a name="infrastructure-logs"></a>インフラストラクチャ ログ
インフラストラクチャ ログには、Azure 診断インフラストラクチャ、RemoteAccess モジュール、および RemoteForwarder モジュールに関する情報があります。 インフラストラクチャ ログに関する情報を収集するには、選択、**インフラストラクチャ ログの転送を有効にする**チェック ボックスをオンします。 インフラストラクチャ ログのストレージ アカウントへの転送間隔を増減するには、変更、**転送間隔 (分)** 値。

![診断インフラストラクチャ ログ](./media/vs-azure-tools-diagnostics-for-cloud-services-and-virtual-machines/IC758148.png)

詳細については、次を参照してください。 [Azure 診断を使用したログ データの収集](https://msdn.microsoft.com/library/azure/gg433048.aspx)します。

### <a name="log-directories"></a>ログ ディレクトリ
ログ ディレクトリでは、インターネット インフォメーション サービス (IIS) の要求、失敗した要求、または選択したフォルダーのログ ディレクトリから収集されたデータがあります。 ログ ディレクトリをキャプチャするには、選択、**ログ ディレクトリの転送を有効にする**チェック ボックスをオンします。 ストレージ アカウントへのログの転送間隔を増減するには、変更、**転送間隔 (分)** 値。

など、収集するログのチェック ボックスをオン**IIS ログ**と**の失敗した要求**ログ。 既定のストレージ コンテナー名が提供されますが、名前を変更することができます。

任意のフォルダーからログをキャプチャすることができます。 パスで指定、**絶対ディレクトリからログ**セクションで、し、**ディレクトリの追加**します。 指定したコンテナーにログがキャプチャされます。

![ログ ディレクトリ](./media/vs-azure-tools-diagnostics-for-cloud-services-and-virtual-machines/IC796665.png)

### <a name="etw-logs"></a>ETW ログ
使用する場合[Windows のイベント トレース](https://msdn.microsoft.com/library/windows/desktop/bb968803\(v=vs.85\).aspx)(ETW) を選択し、ETW ログをキャプチャして、 **ETW ログの転送を有効にする**チェック ボックスをオンします。 ストレージ アカウントへのログの転送間隔を増減するには、変更、**転送間隔 (分)** 値。

イベント ソースと指定したイベント マニフェストからのイベントがキャプチャされます。 イベント ソースを指定する、**イベント ソース**セクションで、名前を入力し、**イベント ソースの追加**します。 同様でイベント マニフェストを指定することができます、**イベント マニフェスト**セクション選び**イベント マニフェストの追加**します。

![ETW ログ](./media/vs-azure-tools-diagnostics-for-cloud-services-and-virtual-machines/IC766025.png)

クラスによって ETW フレームワークが ASP.NET でサポートされている、 [System.Diagnostics.aspx](https://msdn.microsoft.com/library/system.diagnostics(v=vs.110))名前空間。 継承し、標準の拡張 Microsoft.WindowsAzure.Diagnostics 名前空間[System.Diagnostics.aspx](https://msdn.microsoft.com/library/system.diagnostics(v=vs.110))クラスを使用できるように[System.Diagnostics.aspx](https://msdn.microsoft.com/library/system.diagnostics(v=vs.110))としてログ記録Azure 環境でフレームワーク。 詳細については、次を参照してください。 [Microsoft Azure でログ記録とトレースを制御する](https://msdn.microsoft.com/magazine/ff714589.aspx)と[Azure Cloud Services および仮想マシンで診断を有効にする](/azure/cloud-services/cloud-services-dotnet-diagnostics)します。

### <a name="crash-dumps"></a>クラッシュ ダンプ
ロール インスタンスがクラッシュしたときの情報をキャプチャするには、選択、**クラッシュ ダンプの転送を有効にする**チェック ボックスをオンします。 (ASP.NET では、ほとんどの例外を処理するため、これは一般に、ワーカー ロールに対してのみ有効です)。クラッシュ ダンプに充てるストレージ容量の割合を増減するには、変更、**ディレクトリ クォータ (%)** 値。 クラッシュ ダンプが保存されていると、キャプチャするかどうかを選択するストレージ コンテナーを変更することができます、**完全**または**ミニ**ダンプします。

現在追跡されているプロセスは、次のスクリーン ショットに表示されます。 キャプチャするプロセスのチェック ボックスを選択します。 別のプロセスを一覧に追加するに、プロセス名を入力し、選択**プロセスの追加**します。

![クラッシュ ダンプ](./media/vs-azure-tools-diagnostics-for-cloud-services-and-virtual-machines/IC766026.png)

詳細については、次を参照してください。 [Microsoft Azure でログ記録とトレースを制御する](https://msdn.microsoft.com/magazine/ff714589.aspx)と[Microsoft Azure 診断のパート 4: カスタム ログ コンポーネントと Azure 診断 1.3 の変更点](http://justazure.com/microsoft-azure-diagnostics-part-4-custom-logging-components-azure-diagnostics-1-3-changes/)します。

## <a name="view-the-diagnostics-data"></a>診断データを表示します。
クラウド サービスまたは仮想マシンの診断データを収集したら、それを表示できます。

### <a name="to-view-cloud-service-diagnostics-data"></a>クラウド サービスの診断データを表示するには
1. 通常どおりにクラウド サービスをデプロイし、それを実行します。
2. ストレージ アカウントで Visual Studio によって生成されるレポートで、またはテーブルで診断データを表示できます。 Cloud Explorer またはサーバー エクスプ ローラーを開いて、レポートのデータがして、選択したロールのノードのショートカット メニューを表示するビューを**診断データの表示**します。
   
    ![診断データの表示](./media/vs-azure-tools-diagnostics-for-cloud-services-and-virtual-machines/IC748912.png)
   
    使用可能なデータを表示するレポートが表示されます。
   
    ![Visual Studio の Microsoft Azure 診断レポート](./media/vs-azure-tools-diagnostics-for-cloud-services-and-virtual-machines/IC796666.png)
   
    最新のデータが表示されない場合は、転送間隔の経過を待つ必要があります。
   
    データをすぐに更新するには、選択、**更新**リンク。 自動的に更新されたデータで間隔を選択して、**自動更新**ドロップダウン リスト ボックス。 エラー データをエクスポートするには、選択、 **CSV にエクスポート**Excel ワークシートで開くことができるコンマ区切り値ファイルを作成するボタンをクリックします。
   
    Cloud Explorer またはサーバー エクスプ ローラーで、展開に関連付けられているストレージ アカウントを開きます。
3. テーブル ビューアーで診断テーブルを開き、収集したデータを確認します。 IIS ログとカスタム ログの場合は、blob コンテナーを開くことができます。 次の表には、テーブルまたは別のログ ファイルのデータを含む blob コンテナーが一覧表示します。 テーブルのエントリを含む、そのログ ファイルのデータだけでなく**EventTickCount**、 **DeploymentId**、**ロール**、および**RoleInstance**、生成された、データをどの仮想マシンとロールを識別するのに役立つとタイミングです。 
   
   | 診断データ | 説明 | 場所 |
   | --- | --- | --- |
   | アプリケーション ログ |メソッドを呼び出すことによって、コードを生成するログ、 **System.Diagnostics.Trace**クラス。 |WADLogsTable |
   | イベント ログ |仮想マシン上の Windows イベント ログからのデータ。 Windows には、これらのログの情報が保存されますが、アプリケーションとサービスも使用して、エラーを報告するログまたはログ情報。 |WADWindowsEventLogsTable |
   | パフォーマンス カウンター |仮想マシンで利用可能なパフォーマンス カウンターのデータを収集することができます。 オペレーティング システムでは、メモリ使用率やプロセッサ時間など、多くの統計情報が含まれているパフォーマンス カウンターを提供します。 |WADPerformanceCountersTable |
   | インフラストラクチャ ログ |診断インフラストラクチャ自体から生成されるログです。 |WADDiagnosticInfrastructureLogsTable |
   | IIS ログ |Web 要求を記録するログ。 クラウド サービスでは、大量のトラフィックを取得、これらのログが時間のかかるできます。 収集し、必要なときにのみ、このデータを格納することをお勧めします。 |失敗した要求ログ wad-iis-failedreqlogs、そのデプロイ、ロール、およびインスタンスのパスの下で blob コンテナーを確認できます。 Wad-iis のログ ファイルの完全なログを見つけることができます。 各ファイルのエントリは WADDirectories テーブルで行われます。 |
   | クラッシュ ダンプ |クラウド サービスのプロセス (通常は worker ロール) のバイナリ イメージを提供します。 |wad、クラッシュ ダンプの blob コンテナー |
   | カスタム ログ ファイル |ユーザー定義データのログ。 |指定できますコードでカスタム ログ ファイルの場所、ストレージ アカウント。 たとえば、カスタム blob コンテナーを指定できます。 |
4. 任意の型のデータが切り捨てられる場合、そのデータのバッファーを増やすことを試すことができます、ストレージ アカウント、仮想マシンからデータの転送間隔を短くします。
5. (省略可能)全体的な記憶域のコストを削減するには、場合によっては、ストレージ アカウントからデータを消去します。
6. 完全なデプロイを行うと diagnostics.cscfg ファイル (Azure SDK 2.5 の場合は .wadcfgx) が Azure では、更新、クラウド サービスは、診断構成への変更を取得します。 代わりに既存のデプロイを更新する場合は、.cscfg ファイルが Azure で更新されません。 次のセクションの手順に従っても診断の設定を変更できます。 完全なデプロイを実行して、既存のデプロイの更新の詳細については、次を参照してください。 [Azure アプリケーション発行ウィザード](vs-azure-tools-publish-azure-application-wizard.md)します。

### <a name="to-view-virtual-machine-diagnostics-data"></a>仮想マシンの診断データを表示するには
1. 仮想マシンのショートカット メニューを選択**診断データの表示**します。
   
    ![Azure の仮想マシンで診断データの表示](./media/vs-azure-tools-diagnostics-for-cloud-services-and-virtual-machines/IC766027.png)
   
    **診断概要** ダイアログ ボックスが表示されます。
   
    ![Azure 仮想マシン診断の概要](./media/vs-azure-tools-diagnostics-for-cloud-services-and-virtual-machines/IC796667.png)  
   
    最新のデータが表示されない場合は、転送間隔の経過を待つ必要があります。
   
    データをすぐに更新するには、選択、**更新**リンク。 自動的に更新されたデータで間隔を選択して、**自動更新**ドロップダウン リスト ボックス。 エラー データをエクスポートするには、選択、 **CSV にエクスポート**Excel ワークシートで開くことができるコンマ区切り値ファイルを作成するボタンをクリックします。

## <a name="set-up-cloud-service-diagnostics-after-deployment"></a>デプロイ後に、クラウド サービスの診断を設定します。
既に実行されているクラウド サービスに問題を調査している場合は、指定しなかったデータを収集する可能性があるの役割を最初にデプロイする前にします。 この場合、サーバー エクスプ ローラーで、設定を変更することでそのデータの収集を開始できます。 1 つのインスタンスまたは開くかによって、ロール内のすべてのインスタンスのいずれかの診断を設定することができます、**診断構成**インスタンスまたはロールのショートカット メニューからダイアログ ボックス。 ロール ノードを構成する場合は、すべてのインスタンスに対して行った変更が適用されます。 インスタンス ノードを構成する場合は、そのインスタンスにのみを変更することが適用されます。

### <a name="to-set-up-diagnostics-for-a-running-cloud-service"></a>実行中のクラウド サービスの診断を設定するには
1. サーバー エクスプ ローラーで、 **Cloud Services**ノード、ロールまたはインスタンス (またはその両方) を検索するノードの一覧を展開し調査します。
   
    ![診断を構成します。](./media/vs-azure-tools-diagnostics-for-cloud-services-and-virtual-machines/IC748913.png)
2. インスタンス ノードまたはロール ノードのショートカット メニューを選択**診断の設定の更新**、しを収集する診断の設定を選択します。
   
    構成設定については、セクションをご覧ください。**診断データのソース**この記事では。 診断データを表示する方法については、セクションをご覧ください。**診断データの表示**この記事では。
   
    サーバー エクスプ ローラーでデータ収集を変更する場合の変更まで有効になります、クラウド サービスを完全に再デプロイします。 既定値を使用する場合は、発行の設定、変更は上書きされません。 既定の発行設定は完全に再デプロイを行うのではなく、既存のデプロイを更新します。 デプロイ時に、設定が消去されることを確認するには、**詳細設定** タブで、発行ウィザードおよびオフにし、**配置の更新**チェック ボックスをオンします。 そのチェック ボックスをオフで再デプロイするときに、設定を元に戻す .wadcfgx (または .wadcfg) ファイルを通じて、セットとして、**プロパティ**ロール用のエディター。 デプロイを更新する場合、Azure は、以前の設定を保持します。

## <a name="troubleshoot-azure-cloud-service-issues"></a>Azure クラウド サービスの問題をトラブルシューティングします。
「ビジー」の状態のままになるロールをリサイクルすると、繰り返しまたは内部サーバー エラーをスローするように、クラウド サービス プロジェクトで問題が発生した場合はツールと手法、問題を診断して解決に使用することができます。 一般的な問題とソリューションの具体例と概念および診断し、これらのエラーの修正に使用できるツールの概要についてを参照して[Azure PaaS コンピューティング診断データ](http://blogs.msdn.com/b/kwill/archive/2013/08/09/windows-azure-paas-compute-diagnostics-data.aspx)します。

## <a name="q--a"></a>Q & A
**バッファーのサイズと大きさである場合にしますか。**

各仮想マシン インスタンスのクォータによって制限診断データの量は、ローカル ファイル システムに格納できます。 さらに、使用可能な診断データの種類ごとのバッファー サイズを指定します。 このバッファー サイズは、その種類のデータの個々 のクォータのように機能します。 クォータ全体とを残っているメモリの量を確認するのには、診断データの種類のダイアログ ボックスの下部にあるを参照してください。 大きいバッファーまたはデータの種類を指定する場合は、クォータ全体をアプローチしましょう。 クォータ全体を変更するには、diagnostics.wadcfg または .wadcfgx 構成ファイルを変更します。 診断データは、アプリケーションのデータと同じファイル システムに格納されます。 アプリケーションでは、大量のディスク領域を使用する場合は、診断クォータ全体を増加させないでください。

**新機能、転送間隔と、その長さにする方法はでしょうか。**

転送間隔は、時間が経過するまでの間のデータをキャプチャします。 各転送期間の後のデータに移動されますローカル ファイル システムから仮想マシンで、ストレージ アカウント内のテーブル。 収集されるデータの量は、転送間隔の終了前に、クォータを超えている場合は、古いデータは破棄されます。 場合は、データ バッファーのサイズまたは全体のクォータを超えているために、データを失うことは、転送間隔を短く可能性があります。

**どのタイム ゾーンのタイムスタンプか?**

タイムスタンプは、クラウド サービスをホストするデータ センターのローカル タイム ゾーンです。 ログ テーブルで 3 時間スタンプの次列が使用されます。

* **PreciseTimeStamp**: イベントの ETW タイムスタンプです。 クライアントからイベントを記録時間は、します。
* **タイムスタンプ**: の値は、 **PreciseTimeStamp**アップロード頻度境界に丸められました。 たとえば、アップロード頻度が 5 分で、イベントは時刻 00時 17分: 12、タイムスタンプは 00時 15分: 00 が。
* **タイムスタンプ**: Azure テーブルにエンティティが作成されたタイムスタンプ。

**診断情報を収集するときにコストを管理する方法は?**

既定の設定 (**ログ レベル**に設定**エラー**、および**転送期間**に設定**1 分**) のコストを最小限に抑えるように設計されています。 コンピューティング コストより多くの診断データを収集するとき、または転送期間を短縮する場合を増やしてください。 不要になったときに、データの収集を無効にすることを忘れないでくださいして必要なより多くのデータを収集しません。 常に有効にできます、もう一度、実行時にもこの記事で前述したようです。

**IIS から失敗した要求ログを収集する方法**

既定では、IIS は、失敗した要求ログを収集しません。 IIS を設定するには、web ロールの web.config ファイルを編集して失敗した要求ログを収集します。

**OnStart など RoleEntryPoint のメソッドからトレース情報を取得できません。何が問題なのでしょうか?**

メソッド**RoleEntryPoint**は IIS ではなく、WAIISHost.exe のコンテキストで呼び出されます。 トレースを有効に、通常は適用しない web.config の構成情報。 この問題を解決するには、.config ファイルを web ロール プロジェクトに追加し、名前を含む出力アセンブリに一致するファイル、 **RoleEntryPoint**コード。 既定の web ロール プロジェクトに .config ファイルの名前は waiishost.exe.config です。このファイルには、次の行を追加します。

```
<system.diagnostics>
  <trace>
      <listeners>
          <add name “AzureDiagnostics” type=”Microsoft.WindowsAzure.Diagnostics.DiagnosticMonitorTraceListener”>
              <filter type=”” />
          </add>
      </listeners>
  </trace>
</system.diagnostics>
```

**プロパティ**ウィンドウで、設定、**出力ディレクトリにコピー**プロパティを**常にコピー**します。

## <a name="next-steps"></a>次の手順
Azure でのログ記録する診断の詳細については、次を参照してください。 [Azure Cloud Services および仮想マシンで診断を有効にする](/azure/cloud-services/cloud-services-dotnet-diagnostics.md)と[Azure App Service で Web アプリに対して診断ログを有効にする](/azure/app-service/web-sites-enable-diagnostic-log)します。

