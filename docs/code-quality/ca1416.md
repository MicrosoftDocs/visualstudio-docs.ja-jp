---
title: 'ca1416: プラットフォームの互換性を検証する'
ms.date: 09/01/2020
ms.topic: reference
f1_keywords:
- PlatformCompatibilityAnalyzer
- CA1416
helpviewer_keywords:
- PlatformCompatibilityAnalyzer
- CA1416
author: buyaa-n
ms.author: bunamnan
manager: jeffhandley
ms.workload:
- multiple
ms.openlocfilehash: a8185cc625898acd81628f100b6b0bd7d98be417
ms.sourcegitcommit: a18c7e9b367c2f92f6e54c3eaef442775d457667
ms.translationtype: MT
ms.contentlocale: ja-JP
ms.lasthandoff: 09/15/2020
ms.locfileid: "90108614"
---
# <a name="ca1416-validate-platform-compatibility"></a>CA1416: プラットフォームの互換性を検証する

|||
|-|-|
|CheckId|CA1416|
|カテゴリ|Microsoft. 相互運用性|
|互換性に影響する変更点|なし|

## <a name="cause"></a>原因

次のいずれかのコンテキストでプラットフォームに依存する API を使用する場合、違反が報告されます。
- で使用されるプラットフォーム固有の API は次のとおりです。 
  - プラットフォームに依存しないコンテキスト。
  - 異なるプラットフォームコンテキスト。
- API は現在のターゲットプラットフォームではサポートされていません。

この規則は、以降を対象とするプロジェクトに対してのみ既定で有効になってい `net5.0` ます。 ただし、他のフレームワークを対象とするプロジェクトに対して [有効に](#configurability) することができます。

## <a name="rule-description"></a>規則の説明

.NET 5.0 では、プラットフォーム固有の Api に注釈を付けるための新しい属性が追加されました。 これは次のように機能します。
- マークされていない API は、すべての OS プラットフォームで動作していると見なされます。
- でマークされた API `[SupportedOSPlatform("platformName")]` は、指定された OS プラットフォームにのみ移植可能であると見なされます (属性は、異なるプラットフォームで複数回適用できます)。
- でマークされた API `[UnsupportedOSPlatform("platformName")]` は、指定された OS プラットフォームでのみサポートされていると見なされます (属性は、異なるプラットフォームで複数回適用できます)。
- 両方の属性は、プラットフォーム名の一部として、またはバージョン番号なしでインスタンス化できます。
- 属性の組み合わせが存在する場合は `[SupportedOSPlatform] and [UnsupportedOSPlatform]` 、すべての属性を OS プラットフォーム識別子でグループ化します。
  - **許可リスト**。 各 OS プラットフォームの最小バージョンが属性である場合、 `[SupportedOSPlatform]` API は、一覧表示されたプラットフォームでのみサポートされ、他のすべてのプラットフォームではサポートされません。 この一覧には、同じプラットフォームの属性が含まれている可能性 `[UnsupportedOSPlatform]` がありますが、そのバージョンから API が削除されていることを示す上位バージョンのみです。
  - **拒否リスト**。 各 OS プラットフォームの最小バージョンが属性である場合、API は、 `[UnsupportedOSPlatform]` 一覧表示されたプラットフォームでのみサポートされ、他のすべてのプラットフォームでサポートされていると見なされます。 この一覧には、同じプラットフォームの属性が含まれている可能性 `[SupportedOSPlatform]` がありますが、そのバージョンの API がサポートされていることを示す上位バージョンのみです。
  - **不整合な一覧**です。 一部のプラットフォームの最小バージョンが `[SupportedOSPlatform]` `[UnsupportedOSPlatform]` 他のプラットフォーム用である場合、は不整合と見なされ、API の一部の注釈は無視されます。 今後、不整合が発生した場合に警告を生成する別のアナライザーを導入する予定です。

上記の属性で注釈が付けられた Api に異なるプラットフォームコンテキストからアクセスすると、次の違反が発生する可能性があります。

### <a name="violations"></a>違反
- 指定したプラットフォームでのみサポートされている API ( `[SupportedOSPlatform("platformName")]` ) から、他のプラットフォームで到達できるコードからアクセスすると、違反が発生します。 `'API' is supported on 'platformName'.`

  ```csharp
  // an API supported only on linux
  [SupportedOSPlatform("linux")]
  public void LinuxOnlyApi() { }

  // an API supported on windows and ios from version 14.0
  [SupportedOSPlatform("windows")]
  [SupportedOSPlatform("ios14.0")]
  public void SupportedOnWindowsAndIos14() { }

  public void Caller()
  {
      LinuxOnlyApi(); // warns CA1416: 'LinuxOnlyApi' is supported on 'linux'
    
      SupportedOnWindowsAndIos14(); // warns CA1416:'SupportedOnWindowsAndIos14' is supported on 'windows'  
                                    // warns CA1416: 'SupportedOnWindowsAndIos14' is supported on 'ios' 14.0 and later
  }

  ```

  > [!NOTE]
  > 違反は、プロジェクトがサポートされているプラットフォーム () を対象としていない場合にのみ発生し `net5.0-differentPlatform` ます。 これは、複数の対象を持つプロジェクト () にも当てはまり `net5.0` ます。 プロジェクトが指定されたプラットフォーム () を対象としている場合、違反は発生しません `net5.0-platformName` 。

- によって属性が設定された API にアクセスする際には、次のような違反が発生する `[UnsupportedOSPlatform("platformName")]` `platformName` 可能性があります。 `'API' is unsupported on 'platformName'.`

  ```csharp
  // an API not supported on android but supported on all other
  [UnsupportedOSPlatform("android")] 
  public void DoesNotWorkOnAndroid() { }

  // an API was unsupported on windows until version 10.0.1903. The API is considered supported everywhere else without constraints.
  [UnsupportedOSPlatform("windows")]
  [SupportedOSPlatform("windows10.0.1903")]
  public void StartedWindowsSupportFromCertainVersion();

  public void Caller()
  {
      DoesNotWorkOnAndroid(); // warns CA1416:'DoesNotWorkOnAndroid' is unsupported on 'android'
    
      StartedWindowsSupportFromCertainVersion(); // warns CA1416:'StartedWindowsSupportFromCertainVersion' is unsupported on 'windows'  
                                                 // warns CA1416:'StartedWindowsSupportFromCertainVersion' is supported on 'windows' 10.0.1903 and later
  }
  ```

  > [!NOTE]
  > サポートされていないプラットフォームを対象としていないアプリを構築している場合、違反は発生しません。 違反は、次の場合にのみ発生します。
  > - プロジェクトが、サポートされていないという属性を持つプラットフォームを対象としている場合は。
  > - は、 `platformName` 既定の `MSBuild` `<SupportedPlatform>` 項目グループに含まれています。
  > - `platformName`MSBuild アイテムグループにを手動で含める `<SupportedPlatform>` :

  ```XML
  <ItemGroup>
      <SupportedPlatform Include="platformName" />
  </ItemGroup>
  ```

## <a name="how-to-fix-violations"></a>違反の修正方法

これらの違反に対処するための推奨される方法は、適切なプラットフォームで実行されている場合にのみ、これらの Api を呼び出すことができるようにすることです。 これを実現するには、ビルド時に #if と複数のターゲットを使用してコードを除外するか、実行時にコードを条件付きで呼び出す必要があります。 Analyzer では、 <xref:System.OperatingSystem> チェックに使用できる従来のと共に、追加した新しいプラットフォーム保護機能が認識され <xref:System.Runtime.InteropServices.RuntimeInformation.IsOSPlatform%2A?displayProperty=fullName> ます。 

- 呼び出しサイトを platform guard メソッドで囲んで違反を抑制する

  ```csharp
  // an API supported only on linux
  [SupportedOSPlatform("linux")]
  public void LinuxOnlyApi() { }  

  // an API supported on windows and ios from version 14.0
  [SupportedOSPlatform("windows")]
  [SupportedOSPlatform("ios14.0")]
  public void SupportedOnWindowsAndIos14() { }  
                                              
  public void Caller()
  {
      LinuxOnlyApi(); // warns CA1416: 'LinuxOnlyApi' is supported on 'linux'
    
      SupportedOnWindowsAndIos14(); // warns CA1416:'SupportedOnWindowsAndIos14' is supported on 'windows'  
                                    // warns CA1416: 'SupportedOnWindowsAndIos14' is supported on 'ios' 14.0 and later
  }

  // The diagnostics fixed using platform guard methods
  public void Caller()
  {
      if (OperatingSystem.IsLinux())
      {
          LinuxOnlyApi(); // no diagnostic
      }

      if (OperatingSystem.IsIOSVersionAtLeast(14))
      {
          SupportedOnWindowsAndIos14(); // no diagnostic
      }

      if(RuntimeInformation.IsOSPlatform(OSPlatform.Windows))
      {
          SupportedOnWindowsAndIos14(); // no diagnostic
      }
  }

  // an API not supported on android but supported on all other
  [UnsupportedOSPlatform("android")]  
  public void DoesNotWorkOnAndroid() { }

  // an API was unsupported on windows until version 10.0.1903. The API is considered supported everywhere else without constraints.
  [UnsupportedOSPlatform("windows")]
  [SupportedOSPlatform("windows10.0.1903")]
  public void StartedWindowsSupportFromCertainVersion();

  public void Caller()
  {
      DoesNotWorkOnAndroid(); // warns CA1416:'DoesNotWorkOnAndroid' is unsupported on 'android'
    
      StartedWindowsSupportFromCertainVersion(); // warns CA1416:'StartedWindowsSupportFromCertainVersion' is unsupported on 'windows'  
                                                 // warns CA1416:'StartedWindowsSupportFromCertainVersion' is supported on 'windows' 10.0.1903 and later
  }

  public void Caller()
  {
      if (!OperatingSystem.IsAndroid())
      {
          DoesNotWorkOnAndroid(); // no diagnostic
      }

      // Can use &&, || logical operators to guard combined attributes
      if (!OperatingSystem.IsWindows() || OperatingSystem.IsWindowsVersionAtLeast(10, 0, 1903))
      {
          StartedWindowsSupportFromCertainVersion(); // no diagnostic
      }
  }

  ```

- Analyzer は、 <xref:System.Diagnostics.Debug.Assert%2A?displayProperty=fullName> サポートされていないプラットフォームでコードに到達できないようにするための手段としても考慮します。 を使用する `Debug.Assert` と、必要に応じて、リリースビルドからチェックアウトすることができます。

  ```csharp
  // an API supported only on linux
  [SupportedOSPlatform("linux")]
  public void LinuxOnlyApi() { } 

  public void Caller() 
  {
      Debug.Assert(OperatingSystem.IsLinux());

      LinuxOnlyApi(); // No diagnostic
  } 
  ```

- 独自の Api をプラットフォーム固有としてマークすることにより、要件を呼び出し元に効果的に転送できます。 プラットフォーム属性は、次のいずれかに適用できます。
  - 型
  - メンバー (メソッド、フィールド、プロパティ、およびイベント)
  - アセンブリ

  ```csharp
  [SupportedOSPlatform("windows")]
  [SupportedOSPlatform("ios14.0")]
  public void SupportedOnWindowsAndIos14() { }  

  [SupportedOSPlatform("ios15.0")] // call site version should be equal to or higher than the API version
  public void Caller() 
  { 
      SupportedOnWindowsAndIos14(); // No diagnostics
  } 

  [UnsupportedOSPlatform("windows")]
  [SupportedOSPlatform("windows10.0.1903")]
  public void StartedWindowsSupportFromCertainVersion();

  [UnsupportedOSPlatform("windows")]
  [SupportedOSPlatform("windows10.0.1903")]
  public void Caller() 
  { 
      StartedWindowsSupportFromCertainVersion(); // No diagnostics
  } 
  ```

- アセンブリまたは型レベルの属性が適用されると、アセンブリまたは型内のすべてのメンバーは、プラットフォーム固有であると見なされます。

  ```csharp
  [assembly:SupportedOSPlatform("windows")]
  public namespace ns
  {
      public class Sample
      {
          public void SupportedOnWindows() { }  
      
          public void Caller() 
          { 
              SupportedOnWindows(); // No diagnostic as call site and calling method both windows only
          }
      }
  } 
  ```

## <a name="when-to-suppress-warnings"></a>警告を非表示にする場合

適切なプラットフォームコンテキスト/ガードを使用せずにプラットフォーム固有の Api を参照することは推奨されません。 ただし、必要に応じて、通常の方法 ( `<NoWarn>` 、エディターの構成、または #pragma) によってこれらの診断を抑制することができます。

```csharp
[SupportedOSPlatform("linux")]
public void LinuxOnlyApi() { } 

public void Caller() 
{ 
#pragma warning disable CA1416
    LinuxOnlyApi(); 
#pragma warning restore CA1416
} 
```

## <a name="configurability"></a>構成可能の有無

Analyzer は、以降を対象とするプロジェクトに対してのみ既定で有効になり、 `net5.0` [AnalysisLevel](https://docs.microsoft.com/dotnet/core/project-sdk/msbuild-props#analysislevel) は 5 (プロジェクトの既定値) になり `net5.0` ます。 `net5.0`プロジェクトの editorconfig ファイルに次のキーと値のペアを追加することで、よりも前のターゲットフレームワークに対して有効にすることができます。

```ini
dotnet_code_quality.enable_platform_analyzer_on_pre_net5_target=true
```

詳細については、「 [.net コード品質アナライザーの構成](configure-fxcop-analyzers.md)」を参照してください。

## <a name="see-also"></a>関連項目

- [プラットフォーム固有の Api に注釈を付け、その使用を検出する](https://github.com/dotnet/designs/blob/master/accepted/2020/platform-checks/platform-checks.md)
- [特定のプラットフォームでサポートされていない Api に注釈を付ける](https://github.com/dotnet/designs/blob/master/accepted/2020/platform-exclusion/platform-exclusion.md)
- [.NET 5 でのターゲットフレームワーク名](https://github.com/dotnet/designs/blob/master/accepted/2020/net5/net5.md)
- [.NET API アナライザー](https://docs.microsoft.com/dotnet/standard/analyzers/api-analyzer)
- [相互運用性に関する警告](/dotnet/framework/interop/index)